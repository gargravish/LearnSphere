(()=>{"use strict";function e(){try{chrome.contextMenus.removeAll(()=>{console.log("ðŸš€ LearnSphere: Existing context menus removed"),chrome.contextMenus.create({id:"learnsphere-main",title:"ðŸš€ LearnSphere",contexts:["all"]},()=>{chrome.runtime.lastError?console.error("ðŸš€ LearnSphere: Error creating main menu:",chrome.runtime.lastError):(console.log("ðŸš€ LearnSphere: Main context menu created"),[{id:"learnsphere-chat",parentId:"learnsphere-main",title:"ðŸ’¬ Chat about this",contexts:["selection"]},{id:"learnsphere-summary",parentId:"learnsphere-main",title:"ðŸ“ Generate Summary",contexts:["selection"]},{id:"learnsphere-quiz",parentId:"learnsphere-main",title:"ðŸ§  Create Quiz",contexts:["selection"]},{id:"learnsphere-open-sidebar",parentId:"learnsphere-main",title:"ðŸš€ Open LearnSphere Sidebar",contexts:["all"]},{id:"learnsphere-open-viewer",parentId:"learnsphere-main",title:"ðŸ“„ Open with LearnSphere Viewer",contexts:["all"]}].forEach(e=>{chrome.contextMenus.create(e,()=>{chrome.runtime.lastError?console.error("ðŸš€ LearnSphere: Error creating sub-menu:",e.id,chrome.runtime.lastError):console.log("ðŸš€ LearnSphere: Sub-menu created:",e.id)})}))})})}catch(e){console.error("ðŸš€ LearnSphere: Error creating context menus:",e)}}console.log("ðŸš€ LearnSphere: Background script starting..."),chrome.runtime.onInstalled.addListener(()=>{console.log("ðŸš€ LearnSphere: Extension installed/updated, creating context menus..."),e()}),chrome.runtime.onStartup?.addListener(()=>{console.log("ðŸš€ LearnSphere: Browser startup, (re)creating context menus"),e()}),chrome.contextMenus.onClicked.addListener(async(e,r)=>{console.log("ðŸš€ LearnSphere: Context menu clicked:",e.menuItemId,"on tab:",r?.id);let t=r?.id;if(!t||t<0)try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});t=e?.id,console.log(" LearnSphere: Using active tab ID:",t)}catch(e){return void console.error("ðŸš€ LearnSphere: Failed to get active tab:",e)}if(!t||t<0)console.error("ðŸš€ LearnSphere: No valid tab ID available");else try{const r=await chrome.tabs.get(t);if(!r)return void console.error("ðŸš€ LearnSphere: Tab not accessible:",t);const n=r.url?.startsWith(`chrome-extension://${chrome.runtime.id}/`);if(!n&&(r.url?.startsWith("chrome://")||r.url?.startsWith("chrome-extension://")||r.url?.startsWith("edge://")||r.url?.startsWith("about:")))return void console.error("ðŸš€ LearnSphere: Cannot inject content script on restricted page:",r.url);r.url?.startsWith("file://")&&console.warn('ðŸš€ LearnSphere: Page is a local file. Ensure "Allow access to file URLs" is enabled for this extension.');if(!(n&&/\/viewer\.html/i.test(r.url||""))&&!await async function(e){try{return await chrome.tabs.sendMessage(e,{action:"ping"}),console.log("ðŸš€ LearnSphere: Content script already loaded"),!0}catch(r){console.log("ðŸš€ LearnSphere: Content script not loaded, injecting now...");try{await chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]}),console.log("ðŸš€ LearnSphere: Content script injected successfully"),await new Promise(e=>setTimeout(e,500));try{return await chrome.tabs.sendMessage(e,{action:"ping"}),console.log("ðŸš€ LearnSphere: Content script confirmed ready"),!0}catch(e){return console.warn("ðŸš€ LearnSphere: Content script not responding to ping after injection"),!1}}catch(e){return console.error("ðŸš€ LearnSphere: Failed to inject content script:",e),!1}}}(t))return void console.error("ðŸš€ LearnSphere: Could not load content script");switch(e.menuItemId){case"learnsphere-chat":if(e.selectionText){console.log("ðŸš€ LearnSphere: Chat requested for selection:",e.selectionText.substring(0,50)+"..."),await chrome.storage.local.set({selectedText:e.selectionText,pendingAction:"chat",timestamp:Date.now()});try{await chrome.tabs.sendMessage(t,{action:"openChatSidebar",selection:e.selectionText}),console.log("ðŸš€ LearnSphere: Chat sidebar message sent successfully")}catch(e){console.error("ðŸš€ LearnSphere: Failed to send chat sidebar message:",e)}}break;case"learnsphere-summary":if(e.selectionText){console.log("ðŸš€ LearnSphere: Summary requested for selection"),await chrome.storage.local.set({selectedText:e.selectionText,pendingAction:"summary",timestamp:Date.now()});try{await chrome.tabs.sendMessage(t,{action:"generateSummary",selection:e.selectionText}),console.log("ðŸš€ LearnSphere: Summary message sent successfully")}catch(e){console.error("ðŸš€ LearnSphere: Failed to send summary message:",e)}}break;case"learnsphere-quiz":if(e.selectionText){console.log("ðŸš€ LearnSphere: Quiz requested for selection"),await chrome.storage.local.set({selectedText:e.selectionText,pendingAction:"quiz",timestamp:Date.now()});try{await chrome.tabs.sendMessage(t,{action:"generateQuiz",selection:e.selectionText}),console.log("ðŸš€ LearnSphere: Quiz message sent successfully")}catch(e){console.error("ðŸš€ LearnSphere: Failed to send quiz message:",e)}}break;case"learnsphere-open-sidebar":console.log("ðŸš€ LearnSphere: Opening sidebar via context menu");try{await chrome.tabs.sendMessage(t,{action:"openChatSidebar"}),console.log("ðŸš€ LearnSphere: Open sidebar message sent successfully")}catch(e){console.error("ðŸš€ LearnSphere: Failed to send open sidebar message:",e)}break;case"learnsphere-open-viewer":try{let t="";e.linkUrl&&/\.pdf($|\?)/i.test(e.linkUrl)?t=encodeURIComponent(e.linkUrl):r.url&&/\.pdf($|\?)/i.test(r.url)&&(r.url.startsWith("file://")||(t=encodeURIComponent(r.url)));const n=t?`viewer.html?file=${t}`:"viewer.html";await chrome.tabs.create({url:n})}catch(e){console.error("ðŸš€ LearnSphere: Failed to open viewer",e)}break;default:console.log("ðŸš€ LearnSphere: Unknown context menu action:",e.menuItemId)}}catch(e){console.error(" LearnSphere: Error handling context menu action:",e)}}),chrome.runtime.onMessage.addListener((e,r,t)=>{switch(console.log("ðŸš€ LearnSphere: Background received message:",e),e.action){case"testServiceWorker":t({success:!0,message:"Service worker is working!",timestamp:(new Date).toISOString()});break;case"openSidebar":r.tab?.id?chrome.tabs.sendMessage(r.tab.id,{action:"openChatSidebar"}).then(()=>{t({success:!0,message:"Sidebar opening request sent"})}).catch(e=>{console.error("ðŸš€ LearnSphere: Failed to send sidebar opening request:",e),t({success:!1,message:"Failed to send sidebar request: "+e.message})}):t({success:!1,message:"No valid tab ID"});break;default:t({success:!1,message:"Unknown action"})}return!0}),console.log("ðŸš€ LearnSphere: Background script setup complete!")})();