(()=>{"use strict";console.log("ðŸš€ LearnSphere: Content script initializing...");let e=null;async function t(t){const n=e||await async function(){try{const t=await chrome.storage.sync.get("learnsphere_settings"),n=t?.learnsphere_settings?.geminiApiKey||null;return e=n,n}catch(e){return console.warn("LearnSphere: Failed to load API key from storage",e),null}}();if(!n)throw new Error("Gemini API key not configured. Open the extension popup and set the API key.");const s=`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${n}`,r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:t}]}],generationConfig:{temperature:.3,topK:20,topP:.8,maxOutputTokens:800}})});if(!r.ok){const e=await r.text();throw new Error(`Gemini error ${r.status}: ${r.statusText} â€” ${e}`)}const o=await r.json();return o?.candidates?.[0]?.content?.parts?.[0]?.text||"(No response)"}function n(e){let t=e;return t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/_(.+?)_/g,"<em>$1</em>"),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/g,e=>`<a href="${e.startsWith("http")?e:`https://${e}`}" target="_blank" rel="noopener">${e}</a>`),t}function s(e){const t=(s=e,s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")).split(/\r?\n/);var s;const r=[];let o=!1,a=null;const i=()=>{o&&a&&(r.push(`</${a}>`),o=!1,a=null)};for(const e of t){const t=e.trimEnd();if(!t.trim()){i();continue}const s=t.match(/^(#{1,6})\s+(.*)$/);if(s){i();const e=s[1].length;r.push(`<h${e}>${n(s[2])}</h${e}>`);continue}const c=t.match(/^(\d+)\.\s+(.*)$/);if(c){o&&"ol"===a||(i(),r.push("<ol>"),o=!0,a="ol"),r.push(`<li>${n(c[2])}</li>`);continue}const l=t.match(/^[-*]\s+(.*)$/);l?(o&&"ul"===a||(i(),r.push("<ul>"),o=!0,a="ul"),r.push(`<li>${n(l[1])}</li>`)):(i(),r.push(`<p>${n(t)}</p>`))}return i(),`<div class="ls-md">${r.join("\n")}</div>`}function r(e,n){!function(){if(document.getElementById("learnsphere-inline-styles"))return;const e=document.createElement("style");e.id="learnsphere-inline-styles",e.textContent="\n    #learnsphere-sidebar { position: fixed; top: 0; right: 0; height: 100%; width: 380px; max-width: 92vw; background: #ffffff; box-shadow: -2px 0 12px rgba(0,0,0,0.15); z-index: 2147483647; display: flex; flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Arial, sans-serif; }\n    .ls-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #eee; }\n    .ls-header h2 { margin: 0; font-size: 16px; }\n    .ls-close { border: none; background: transparent; font-size: 18px; cursor: pointer; line-height: 1; padding: 4px 8px; }\n    .ls-tabs { display: flex; gap: 6px; padding: 8px 12px; border-bottom: 1px solid #f1f1f1; }\n    .ls-tab { padding: 6px 10px; border-radius: 6px; border: 1px solid #e5e7eb; background: #f9fafb; cursor: pointer; font-size: 12px; }\n    .ls-tab.active { background: #e6f0ff; border-color: #bcd2ff; }\n    .ls-content { flex: 1; overflow: auto; padding: 12px; }\n    .ls-footer { border-top: 1px solid #eee; padding: 8px 12px; }\n    .ls-textarea { width: 100%; min-height: 70px; resize: vertical; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; }\n    .ls-button { margin-top: 8px; width: 100%; padding: 8px 10px; border: none; border-radius: 6px; background: #2563eb; color: #fff; cursor: pointer; font-size: 13px; }\n    .ls-chip { display: inline-block; padding: 2px 6px; background: #f3f4f6; border-radius: 999px; font-size: 11px; color: #374151; }\n    .ls-message { padding: 10px 12px; border-radius: 8px; margin: 8px 0; font-size: 13px; line-height: 1.55; }\n    .ls-message.user { background: #eef2ff; border: 1px solid #e0e7ff; color: #1e3a8a; }\n    .ls-message.assistant { background: #eef6ff; border: 1px solid #dbeafe; color: #1e40af; }\n    .ls-md h1 { font-size: 18px; margin: 10px 0 8px; }\n    .ls-md h2 { font-size: 16px; margin: 10px 0 6px; }\n    .ls-md h3 { font-size: 15px; margin: 8px 0 6px; }\n    .ls-md p { margin: 8px 0; }\n    .ls-md ul, .ls-md ol { margin: 8px 0 8px 18px; }\n    .ls-md li { margin: 4px 0; }\n    .ls-md code { background: #f3f4f6; padding: 2px 4px; border-radius: 4px; }\n    .ls-md pre { background: #0f172a; color: #e2e8f0; padding: 8px; border-radius: 6px; overflow: auto; }\n    .ls-md a { color: #1d4ed8; text-decoration: underline; }\n    .ls-md strong { font-weight: 600; }\n    .ls-md em { font-style: italic; }\n    /* Quiz specific */\n    .ls-quiz-q { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; margin: 18px 0 24px; background: #ffffff; }\n    .ls-quiz-q h4 { margin: 0 0 10px; font-size: 14px; }\n    .ls-quiz-options { display: grid; gap: 10px; margin: 10px 0 12px; }\n    .ls-quiz-option { display: flex; align-items: flex-start; gap: 8px; padding: 6px 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; }\n    .ls-quiz-option input { margin-top: 3px; }\n    .ls-quiz-option.correct { border-color: #22c55e; background: #f0fdf4; }\n    .ls-quiz-option.incorrect { border-color: #ef4444; background: #fef2f2; }\n    .ls-quiz-result { margin-top: 10px; font-size: 12px; padding: 8px 10px; border-left: 3px solid #93c5fd; background: #eff6ff; border-radius: 6px; }\n  ",document.head.appendChild(e)}(),function(){const e=document.getElementById("learnsphere-sidebar");e&&e.remove()}();const o=document.createElement("div");o.id="learnsphere-sidebar";const a=document.createElement("div");a.className="ls-header";const i=document.createElement("h2");i.textContent="chat"===e?"LearnSphere â€” Chat":"summary"===e?"LearnSphere â€” Summary":"LearnSphere â€” Quiz";const c=document.createElement("button");c.className="ls-close",c.textContent="Ã—",c.title="Close",c.addEventListener("click",()=>o.remove()),a.append(i,c);const l=document.createElement("div");l.className="ls-tabs",[{key:"chat",label:"Chat"},{key:"summary",label:"Summary"},{key:"quiz",label:"Quiz"}].forEach(t=>{const s=document.createElement("button");s.className="ls-tab"+(t.key===e?" active":""),s.textContent=t.label,s.addEventListener("click",()=>r(t.key,n)),l.appendChild(s)});const d=document.createElement("div");d.className="ls-content";const p=document.createElement("div");if(p.className="ls-footer","chat"===e){if(n){const e=document.createElement("div");e.className="ls-chip",e.textContent=`Selected: ${n.slice(0,60)}${n.length>60?"â€¦":""}`,d.appendChild(e)}const e=document.createElement("div");e.id="ls-chat-history";const r=document.createElement("div");r.className="ls-message assistant",r.innerHTML=s("Ask me anything about this page or your selection."),e.appendChild(r),d.appendChild(e);const o=document.createElement("textarea");o.id="ls-chat-input",o.placeholder="Type your questionâ€¦",o.className="ls-textarea";const a=document.createElement("button");a.className="ls-button",a.textContent="Send",a.addEventListener("click",async()=>{const r=o.value.trim();if(!r)return;const a=document.createElement("div");a.className="ls-message user",a.innerHTML=s(r),e.appendChild(a),o.value="";const i=document.createElement("div");i.className="ls-message assistant",i.textContent="Thinkingâ€¦",e.appendChild(i),e.scrollTop=e.scrollHeight;try{const e="Respond in clean Markdown with headings, bullet points, and numbered steps when helpful. Keep answers concise and scannable.",o=n?`\n\nContext (selected):\n${n}`:"",a=await t(`${e}\n\nQuestion: ${r}${o}`);i.innerHTML=s(a)}catch(e){i.innerHTML=s(`**Error:** ${e.message}`)}e.scrollTop=e.scrollHeight}),p.append(o,a)}if("summary"===e){const e=document.createElement("div");e.className="ls-message assistant",e.innerHTML=s(`**Selected Text**\n\n${n||"No text selected."}`),d.appendChild(e);const r=document.createElement("div");r.id="ls-summary-output",r.className="ls-message assistant",r.textContent="Click the button below to generate a summary.",d.appendChild(r);const o=document.createElement("button");o.className="ls-button",o.textContent="Generate Summary",o.addEventListener("click",async()=>{try{const e=`Summarize the following text using Markdown. Include a short title, key bullet points, and a brief takeaway section.\n\n${n||window.getSelection()?.toString()||document.title}`;r.textContent="Generatingâ€¦";const o=await t(e);r.innerHTML=s(o)}catch(e){r.innerHTML=s(`**Error:** ${e.message}`)}}),p.appendChild(o)}if("quiz"===e){const e=document.createElement("div");e.className="ls-message assistant",e.innerHTML=s(`**Selected Text**\n\n${n||"No text selected."}`),d.appendChild(e);const r=document.createElement("div");r.id="ls-quiz-output",r.className="ls-message assistant",r.textContent="Click the button below to generate a quiz.",d.appendChild(r);const o=document.createElement("button");o.className="ls-button",o.textContent="Generate Quiz",o.addEventListener("click",async()=>{try{const e=`Return ONLY valid JSON (no markdown fences, no extra text): an array of 5 objects with fields \n{"question": string, "options": [string,string,string,string], "correctAnswer": number (0-3), "explanation": string} \nbased on this text: \n${n||window.getSelection()?.toString()||document.title}`;r.textContent="Generatingâ€¦";const o=function(e){try{const n=(t=e,t.replace(/^```[a-zA-Z]*\n/m,"").replace(/```\s*$/m,"")).trim(),s=n.indexOf("["),r=n.lastIndexOf("]"),o=-1!==s&&-1!==r?n.slice(s,r+1):n,a=JSON.parse(o);return Array.isArray(a)?a.filter(e=>e&&Array.isArray(e.options)&&"number"==typeof e.correctAnswer).map(e=>({question:String(e.question||""),options:e.options.slice(0,4).map(e=>String(e)),correctAnswer:Math.min(Math.max(Number(e.correctAnswer),0),3),explanation:String(e.explanation||"")})):null}catch{return null}var t}(await t(e));if(!o||!o.length)return void(r.innerHTML=s("**Sorry**: Could not parse quiz data. Please try again."));r.innerHTML="",function(e,t){t.forEach((t,n)=>{const r=document.createElement("div");r.className="ls-quiz-q";const o=document.createElement("h4");o.textContent=`Q${n+1}. ${t.question}`,r.appendChild(o);const a=document.createElement("div");a.className="ls-quiz-options";const i=`lsq-${Date.now()}-${n}`;t.options.forEach((e,t)=>{const n=document.createElement("label");n.className="ls-quiz-option";const r=document.createElement("input");r.type="radio",r.name=i,r.value=String(t);const o=document.createElement("span");o.innerHTML=s(e),n.append(r,o),a.appendChild(n)});const c=document.createElement("div");c.className="ls-quiz-result",a.addEventListener("change",e=>{const n=Number(e.target.value);a.querySelectorAll(".ls-quiz-option").forEach(e=>e.classList.remove("correct","incorrect"));const r=Array.from(a.querySelectorAll(".ls-quiz-option"));n===t.correctAnswer?(r[n].classList.add("correct"),c.innerHTML=s("**Correct!**\n\n"+t.explanation)):(r[n].classList.add("incorrect"),r[t.correctAnswer]&&r[t.correctAnswer].classList.add("correct"),c.innerHTML=s("**Incorrect.**\n\n"+t.explanation))}),r.append(a,c),e.appendChild(r)})}(r,o)}catch(e){r.innerHTML=s(`**Error:** ${e.message}`)}}),p.appendChild(o)}o.append(a,l,d,p),document.body.appendChild(o)}chrome.runtime.onMessage.addListener((e,t,n)=>{try{if("ping"===e.action)return n({success:!0,message:"pong"}),!0;if("openChatSidebar"===e.action)return r("chat",e.selection),n({success:!0}),!0;if("generateSummary"===e.action)return r("summary",e.selection),n({success:!0}),!0;if("generateQuiz"===e.action)return r("quiz",e.selection),n({success:!0}),!0;n({success:!1,message:"Unknown action"})}catch(e){console.error("ðŸš€ LearnSphere: Error in message handler:",e),n({success:!1,message:e.message})}return!0}),console.log("ðŸš€ LearnSphere: Content script ready.")})();