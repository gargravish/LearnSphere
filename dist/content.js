(()=>{"use strict";var e,t={922:(e,t,n)=>{class i{constructor(){this.tesseract=null,this.isInitialized=!1,this.worker=null,this.init()}async init(){await this.loadTesseract()}async loadTesseract(){return new Promise(e=>{if(window.Tesseract)return this.tesseract=window.Tesseract,void e();const t=document.createElement("script");t.src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js",t.onload=()=>{this.tesseract=window.Tesseract,e()},t.onerror=()=>{console.error("Failed to load Tesseract.js"),e()},document.head.appendChild(t)})}async initializeWorker(e="eng"){if(!this.tesseract)throw new Error("Tesseract.js not loaded");try{this.worker=await this.tesseract.createWorker(e),this.isInitialized=!0,console.log("OCR service initialized successfully")}catch(e){throw console.error("Failed to initialize OCR worker:",e),e}}async recognizeCanvas(e,t={}){if(!this.isInitialized||!this.worker)throw new Error("OCR service not initialized");try{t.language&&(await this.worker.loadLanguage(t.language),await this.worker.initialize(t.language)),t.tessedit_char_whitelist&&await this.worker.setParameters({tessedit_char_whitelist:t.tessedit_char_whitelist}),void 0!==t.tessedit_pageseg_mode&&await this.worker.setParameters({tessedit_pageseg_mode:t.tessedit_pageseg_mode}),t.preserve_interword_spaces&&await this.worker.setParameters({preserve_interword_spaces:t.preserve_interword_spaces});const n=await this.worker.recognize(e);return{text:n.data.text,confidence:n.data.confidence/100,words:n.data.words.map(e=>({text:e.text,confidence:e.confidence/100,bbox:e.bbox})),lines:n.data.lines.map(e=>({text:e.text,confidence:e.confidence/100,bbox:e.bbox}))}}catch(e){throw console.error("OCR recognition failed:",e),e}}async recognizeImage(e,t={}){return new Promise((n,i)=>{const s=new Image;s.crossOrigin="anonymous",s.onload=async()=>{try{const e=document.createElement("canvas"),o=e.getContext("2d");if(!o)return void i(new Error("Failed to get canvas context"));e.width=s.width,e.height=s.height,o.drawImage(s,0,0);const r=await this.recognizeCanvas(e,t);n(r)}catch(e){i(e)}},s.onerror=()=>{i(new Error("Failed to load image"))},s.src=e})}async recognizeImageData(e,t={}){const n=document.createElement("canvas"),i=n.getContext("2d");if(!i)throw new Error("Failed to get canvas context");return n.width=e.width,n.height=e.height,i.putImageData(e,0,0),this.recognizeCanvas(n,t)}async recognizeRegion(e,t,n={}){const i=document.createElement("canvas"),s=i.getContext("2d");if(!s)throw new Error("Failed to get canvas context");return i.width=t.width,i.height=t.height,s.drawImage(e,t.x,t.y,t.width,t.height,0,0,t.width,t.height),this.recognizeCanvas(i,n)}async detectText(e,t=.3){try{const n=await this.recognizeCanvas(e,{tessedit_pageseg_mode:6});return{hasText:n.confidence>t,confidence:n.confidence}}catch(e){return console.warn("Text detection failed:",e),{hasText:!1,confidence:0}}}async recognizeMultipleRegions(e,t,n={}){const i=t.map(t=>this.recognizeRegion(e,t,n));return Promise.all(i)}async getAvailableLanguages(){if(!this.tesseract)throw new Error("Tesseract.js not loaded");try{const e=await this.tesseract.getLanguages();return Object.keys(e)}catch(e){return console.error("Failed to get available languages:",e),["eng"]}}async setParameters(e){if(!this.isInitialized||!this.worker)throw new Error("OCR service not initialized");await this.worker.setParameters(e)}async terminate(){this.worker&&(await this.worker.terminate(),this.worker=null,this.isInitialized=!1)}getStatus(){return{initialized:this.isInitialized,tesseractLoaded:!!this.tesseract,workerActive:!!this.worker}}preprocessImage(e){const t=e.getContext("2d");if(!t)throw new Error("Failed to get canvas context");const n=t.getImageData(0,0,e.width,e.height),i=n.data;for(let e=0;e<i.length;e+=4){const t=.299*i[e]+.587*i[e+1]+.114*i[e+2]>128?255:0;i[e]=t,i[e+1]=t,i[e+2]=t}return t.putImageData(n,0,0),e}async batchRecognize(e,t={}){const n=e.map(e=>"string"==typeof e?this.recognizeImage(e,t):this.recognizeCanvas(e,t));return Promise.all(n)}}class s{constructor(){this.pdfjsLib=null,this.vertexAI=null,this.embeddingsCache=new Map,this.ocrService=new i,this.init()}async init(){await this.loadPDFJS(),await this.initVertexAI(),await this.ocrService.initializeWorker()}async loadPDFJS(){return new Promise(e=>{if(window.pdfjsLib)return this.pdfjsLib=window.pdfjsLib,void e();const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.onload=()=>{this.pdfjsLib=window.pdfjsLib,this.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",e()},t.onerror=()=>{console.error("Failed to load PDF.js"),e()},document.head.appendChild(t)})}async initVertexAI(){console.log("Vertex AI initialization placeholder")}async processDocument(e){if(!this.pdfjsLib)throw new Error("PDF.js not loaded");try{const t=this.pdfjsLib.getDocument(e),n=await t.promise,i={id:this.generateDocumentId(),title:n.info?.Title||"Untitled Document",url:e,pages:[],metadata:{author:n.info?.Author,subject:n.info?.Subject,keywords:n.info?.Keywords?.split(",").map(e=>e.trim()),creationDate:n.info?.CreationDate,modificationDate:n.info?.ModDate}},s=[],o=[];for(let e=1;e<=n.numPages;e++){const t=await n.getPage(e),r=await this.processPage(t,e);i.pages.push({pageNumber:e,text:r.text,images:r.images.map(t=>({src:t.dataUrl,alt:`${t.type} on page ${e}`,coordinates:t.coordinates})),coordinates:r.metadata.coordinates});const a=await this.generateEmbeddings(r.text,e,r.metadata.coordinates);s.push(...a),o.push(...r.images)}return this.embeddingsCache.set(i.id,s),{document:i,embeddings:s,images:o}}catch(e){throw console.error("Error processing document:",e),new Error(`Failed to process document: ${e}`)}}async processPage(e,t){const n=e.getViewport({scale:1}),i=await e.getTextContent(),s=this.extractTextFromContent(i),o=await this.extractImages(e,n);let r="";s.trim().length<50&&(r=await this.performOCR(e,n));const a=s+(r?"\n"+r:"");return{text:a,images:o,metadata:{pageNumber:t,coordinates:{x:0,y:0,width:n.width,height:n.height},confidence:this.calculateConfidence(a,o)}}}extractTextFromContent(e){let t="",n=-1,i=0;for(const s of e.items){const{str:e,transform:o}=s;if(e.trim()){const s=o[5];-1!==n&&Math.abs(s-n)>.5*i&&(t+="\n"),t+=e,n=s,i=Math.max(i,Math.abs(o[3]))}}return t.trim()}async extractImages(e,t){const n=[];try{const t=await e.getOperatorList(),i=e.commonObjs;for(let e=0;e<t.fnArray.length;e++){const s=t.fnArray[e],o=t.argsArray[e];if(s===this.pdfjsLib.OPS.paintImageXObject){const e=i.get(o[0]);if(e&&e.data){const t=document.createElement("canvas"),i=t.getContext("2d");if(i&&e.data){const s=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height);i.putImageData(s,0,0);const o=t.toDataURL("image/png"),r={x:0,y:0,width:e.width,height:e.height};n.push({dataUrl:o,coordinates:r,type:this.classifyImageType(e),confidence:.8})}}}}}catch(e){console.warn("Error extracting images:",e)}return n}classifyImageType(e){const{width:t,height:n}=e,i=t/n;return i>2||i<.5?"chart":t<100&&n<100?"equation":"diagram"}async performOCR(e,t){try{const n=document.createElement("canvas"),i=n.getContext("2d");if(!i)return console.warn("Failed to get canvas context for OCR"),"";n.width=t.width,n.height=t.height;const s={canvasContext:i,viewport:t};return await e.render(s).promise,this.ocrService.preprocessImage(n),(await this.ocrService.recognizeCanvas(n,{tessedit_pageseg_mode:6,preserve_interword_spaces:"1"})).text}catch(e){return console.warn("OCR processing failed:",e),""}}calculateConfidence(e,t){let n=.5;return e.length>100?n+=.3:e.length>50&&(n+=.2),t.length>0&&(n+=.1),Math.min(n,1)}async generateEmbeddings(e,t,n){const i=[],s=this.chunkText(e,512);for(let e=0;e<s.length;e++){const o=s[e],r=await this.getEmbedding(o);i.push({text:o,embedding:r,metadata:{pageNumber:t,startIndex:512*e,endIndex:512*(e+1),coordinates:n}})}return i}chunkText(e,t){const n=e.split(/\s+/),i=[];let s=[],o=0;for(const e of n)o+e.length>t&&s.length>0?(i.push(s.join(" ")),s=[e],o=e.length):(s.push(e),o+=e.length+1);return s.length>0&&i.push(s.join(" ")),i}async getEmbedding(e){return console.log("Getting embedding for:",e.substring(0,50)+"..."),new Array(768).fill(0).map(()=>Math.random()-.5)}async searchSimilarContent(e,t,n=5){const i=await this.getEmbedding(e),s=this.embeddingsCache.get(t);if(!s)throw new Error("Document embeddings not found");return s.map(e=>({...e,similarity:this.cosineSimilarity(i,e.embedding)})).sort((e,t)=>t.similarity-e.similarity).slice(0,n).map(({similarity:e,...t})=>t)}cosineSimilarity(e,t){if(e.length!==t.length)throw new Error("Vectors must have same length");let n=0,i=0,s=0;for(let o=0;o<e.length;o++)n+=e[o]*t[o],i+=e[o]*e[o],s+=t[o]*t[o];return n/(Math.sqrt(i)*Math.sqrt(s))}async processSelection(e,t){let n="";if("text"in e)n=e.text;else{const i=t.pages.find(t=>t.pageNumber===e.pageNumber);i&&(n=this.extractTextFromArea(i.text,e.coordinates))}return{context:n,relatedContent:await this.searchSimilarContent(n,t.id,3)}}extractTextFromArea(e,t){const n=e.split(/\s+/),i=10*Math.floor(t.x/100),s=Math.min(i+50,n.length);return n.slice(i,s).join(" ")}generateDocumentId(){return`doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}clearCache(e){this.embeddingsCache.delete(e)}getCacheStats(){return{size:this.embeddingsCache.size,documents:Array.from(this.embeddingsCache.keys())}}}class o{constructor(e){this.baseUrl="https://generativelanguage.googleapis.com/v1beta/models",this.isInitialized=!1,this.conversationHistory=[],this.documentContext=null,this.config={apiKey:"",model:"gemini-1.5-flash",maxTokens:2048,temperature:.7,topP:.8,topK:40,safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}],...e}}async initialize(e){if(!this.isInitialized){if(e&&(this.config.apiKey=e),!this.config.apiKey)throw new Error("Gemini API key is required. Please provide it in the configuration.");await this.testConnection(),this.isInitialized=!0,console.log("Gemini AI Service initialized successfully")}}async testConnection(){try{const e={contents:[{role:"user",parts:[{text:"Hello, this is a test message."}]}],generationConfig:{temperature:.1,topK:1,topP:.1,maxOutputTokens:10,stopSequences:[]}},t=await this.makeRequest(e);if(!t.candidates||0===t.candidates.length)throw new Error("Invalid response from Gemini API");console.log("Gemini API connection test successful")}catch(e){throw console.error("Gemini API connection test failed:",e),new Error(`Failed to connect to Gemini API: ${e instanceof Error?e.message:"Unknown error"}`)}}setDocumentContext(e){this.documentContext=e,console.log("Document context set for RAG:",e.title)}clearDocumentContext(){this.documentContext=null,this.conversationHistory=[],console.log("Document context cleared")}addToHistory(e){this.conversationHistory.push(e),this.conversationHistory.length>20&&(this.conversationHistory=this.conversationHistory.slice(-20))}async getRelevantContext(e,t){if(!this.documentContext)return[];const n=[];t&&("text"in t?n.push(`Selected text: "${t.text}"`):n.push(`Selected area on page ${t.pageNumber}`));for(const t of this.documentContext.pages)if(t.text){const i=e.toLowerCase().split(" "),s=t.text.toLowerCase().split(" ");if(i.filter(e=>s.some(t=>t.includes(e))).length>0){const e=t.text.split(/[.!?]+/).filter(e=>i.some(t=>e.toLowerCase().includes(t)));e.length>0&&n.push(`Page ${t.pageNumber}: ${e.slice(0,3).join(". ")}`)}}return n.slice(0,5)}async generateRAGResponse(e,t){if(!this.isInitialized)throw new Error("Gemini AI Service not initialized");try{const n=await this.getRelevantContext(e,t),i={contents:[{role:"user",parts:[{text:this.buildRAGPrompt(e,n,t)}]}],generationConfig:{temperature:this.config.temperature,topK:this.config.topK,topP:this.config.topP,maxOutputTokens:this.config.maxTokens,stopSequences:[]},safetySettings:this.config.safetySettings},s=await this.makeRequest(i);if(!s.candidates||0===s.candidates.length)throw new Error("No response generated from Gemini API");const o=s.candidates[0].content.parts[0].text;return this.addToHistory({id:`msg_${Date.now()}`,role:"user",content:e,timestamp:new Date}),this.addToHistory({id:`msg_${Date.now()}_ai`,role:"assistant",content:o,timestamp:new Date}),o}catch(e){throw console.error("Error generating RAG response:",e),new Error(`Failed to generate response: ${e instanceof Error?e.message:"Unknown error"}`)}}buildRAGPrompt(e,t,n){let i="";t.length>0&&(i=`\n\nRelevant document context:\n${t.join("\n\n")}`);let s="";n&&(s="text"in n?`\n\nUser has selected this text: "${n.text}"`:`\n\nUser has selected an area on page ${n.pageNumber}`);const o=this.conversationHistory.slice(-6).map(e=>`${e.role}: ${e.content}`).join("\n");return`You are LearnSphere, an AI study assistant designed to help students understand PDF documents. You have access to the document content and should provide helpful, educational responses based on the context provided.\n\nKey guidelines:\n- Always base your responses on the document content provided\n- Be educational and helpful, explaining concepts clearly\n- If the user asks about something not in the document, acknowledge this and suggest they look elsewhere\n- Use a friendly, encouraging tone\n- Keep responses concise but informative\n- If asked about specific text or areas, reference them directly${i}${s}${o?`\n\nRecent conversation:\n${o}`:""}\n\nUser: ${e}\nLearnSphere:`}async generateSummary(e="document"){if(!this.documentContext)throw new Error("No document context available");const t={contents:[{role:"user",parts:[{text:this.buildSummaryPrompt(e)}]}],generationConfig:{temperature:.3,topK:20,topP:.8,maxOutputTokens:1e3,stopSequences:[]}};try{return(await this.makeRequest(t)).candidates[0].content.parts[0].text}catch(e){throw console.error("Error generating summary:",e),new Error(`Failed to generate summary: ${e instanceof Error?e.message:"Unknown error"}`)}}buildSummaryPrompt(e){if(!this.documentContext)throw new Error("No document context available");let t="",n="";switch(e){case"page":t=this.documentContext.pages[0]?.text||"",n="Provide a concise summary of this page, highlighting the key points and main concepts.";break;case"chapter":t=this.documentContext.pages.slice(0,5).map(e=>e.text).join("\n\n"),n="Provide a comprehensive summary of this chapter, organizing the key concepts and main ideas.";break;case"document":t=this.documentContext.pages.map(e=>e.text).join("\n\n"),n="Provide a comprehensive summary of this document, highlighting the main topics, key concepts, and overall structure."}return`You are an expert at summarizing educational content. ${n}\n\nDocument content:\n${t}\n\nSummary:`}async generateQuizQuestions(e=5,t="medium"){if(!this.documentContext)throw new Error("No document context available");const n={contents:[{role:"user",parts:[{text:`Generate ${e} multiple choice questions based on the following document content. The questions should be ${t} difficulty level.\n\nRequirements:\n- Each question should have 4 options (A, B, C, D)\n- Only one correct answer per question\n- Include explanations for the correct answer\n- Questions should test understanding, not just memorization\n- Make distractors plausible but clearly incorrect\n\nDocument content:\n${this.documentContext.pages.map(e=>e.text).join("\n\n")}\n\nPlease format your response as a JSON array with the following structure:\n[\n  {\n    "question": "Question text here?",\n    "options": ["Option A", "Option B", "Option C", "Option D"],\n    "correctAnswer": 0,\n    "explanation": "Explanation of why this is correct"\n  }\n]`}]}],generationConfig:{temperature:.7,topK:40,topP:.8,maxOutputTokens:2e3,stopSequences:[]}};try{const e=(await this.makeRequest(n)).candidates[0].content.parts[0].text;try{return JSON.parse(e)}catch(t){return console.warn("Failed to parse quiz questions as JSON, returning raw response"),[{question:"Failed to generate structured quiz questions",options:["Please try again"],correctAnswer:0,explanation:e}]}}catch(e){throw console.error("Error generating quiz questions:",e),new Error(`Failed to generate quiz questions: ${e instanceof Error?e.message:"Unknown error"}`)}}async makeRequest(e){const t=`${this.baseUrl}/${this.config.model}:generateContent?key=${this.config.apiKey}`,n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok){const e=await n.text();throw new Error(`Gemini API error: ${n.status} ${n.statusText} - ${e}`)}return await n.json()}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}getConversationHistory(){return[...this.conversationHistory]}clearConversationHistory(){this.conversationHistory=[]}getStatus(){return{initialized:this.isInitialized,hasApiKey:!!this.config.apiKey,hasDocumentContext:!!this.documentContext,conversationLength:this.conversationHistory.length}}}var r=n(329);class a{constructor(e){this.currentDocument=null,this.chapterCache=new Map,this.aiService=e}setDocument(e){this.currentDocument=e,this.chapterCache.clear(),console.log("Document set for summary service:",e.title)}async generateSummary(e,t){if(!this.currentDocument)throw new Error("No document available for summary generation");const n=Date.now(),i=`summary_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{let s="",o=[];switch(e.scope){case"page":s=await this.getPageContent(1),o=[1];break;case"chapter":const e=await this.getChapterContent(1);s=e.content,o=Array.from({length:e.endPage-e.startPage+1},(t,n)=>e.startPage+n);break;case"document":s=this.currentDocument.pages.map(e=>e.text).join("\n\n"),o=this.currentDocument.pages.map(e=>e.pageNumber);break;case"selection":if(!t)throw new Error("Selection text is required for selection-based summary");s=t,o=[1]}const r=await this.generateSummaryContent(s,e),a=e.includeKeyPoints?await this.extractKeyPoints(s,e):void 0,c=e.includeDefinitions?await this.extractDefinitions(s,e):void 0,l=Date.now()-n;return{id:i,content:r,keyPoints:a,definitions:c,metadata:{scope:e.scope,style:e.style,pageNumbers:o,wordCount:this.countWords(r),generatedAt:new Date,processingTime:l}}}catch(e){throw console.error("Error generating summary:",e),new Error(`Failed to generate summary: ${e instanceof Error?e.message:"Unknown error"}`)}}async generateSummaryContent(e,t){const n=this.buildSummaryPrompt(e,t);try{return await this.aiService.generateRAGResponse(n)}catch(e){throw console.error("Error generating summary content:",e),new Error("Failed to generate summary content")}}buildSummaryPrompt(e,t){const n=this.getStyleInstructions(t.style),i=this.getLengthConstraint(t.maxLength);return`You are an expert at creating educational summaries. Please create a ${t.style} summary of the following content.\n\n${n}\n\n${i}\n\nContent to summarize:\n${e}\n\nPlease provide a clear, well-structured summary that captures the main ideas and key concepts.`}getStyleInstructions(e){switch(e){case"brief":return"Create a concise summary focusing on the most important points. Keep it short and to the point.";case"detailed":return"Create a comprehensive summary that covers all major topics and provides thorough explanations.";case"bullet-points":return"Create a summary in bullet-point format, organizing information clearly and hierarchically.";case"academic":return"Create an academic-style summary with formal language, proper structure, and scholarly tone.";default:return"Create a clear and informative summary."}}getLengthConstraint(e){return e<=100?"Keep the summary very brief, under 100 words.":e<=300?"Keep the summary concise, under 300 words.":e<=500?"Keep the summary moderate in length, under 500 words.":"The summary can be comprehensive but should not exceed 1000 words."}async extractKeyPoints(e,t){const n=`Extract the 5-7 most important key points from the following content. Present them as a numbered list.\n\nContent:\n${e}\n\nKey Points:`;try{const e=await this.aiService.generateRAGResponse(n);return this.parseKeyPoints(e)}catch(e){return console.error("Error extracting key points:",e),[]}}parseKeyPoints(e){const t=e.split("\n"),n=[];for(const e of t){const t=e.trim();if(t.match(/^\d+\.\s/)||t.match(/^[-*]\s/)){const e=t.replace(/^\d+\.\s/,"").replace(/^[-*]\s/,"");e.length>0&&n.push(e)}}return n.slice(0,7)}async extractDefinitions(e,t){const n=`Extract important terms and their definitions from the following content. Present them in this format:\nTerm: Definition\n\nContent:\n${e}\n\nTerms and Definitions:`;try{const e=await this.aiService.generateRAGResponse(n);return this.parseDefinitions(e)}catch(e){return console.error("Error extracting definitions:",e),[]}}parseDefinitions(e){const t=[],n=e.split("\n");for(let e=0;e<n.length;e++){const i=n[e].trim();if(i.includes(":")){const[e,...n]=i.split(":");if(n.length>0){const i=n.join(":").trim();e.trim()&&i&&t.push({term:e.trim(),definition:i})}}}return t.slice(0,10)}async getPageContent(e){if(!this.currentDocument)throw new Error("No document available");const t=this.currentDocument.pages.find(t=>t.pageNumber===e);if(!t)throw new Error(`Page ${e} not found`);return t.text||""}async getChapterContent(e){if(!this.currentDocument)throw new Error("No document available");const t=Math.min(5,this.currentDocument.pages.length),n=this.currentDocument.pages.filter(e=>e.pageNumber>=1&&e.pageNumber<=t).map(e=>e.text).join("\n\n");return{startPage:1,endPage:t,title:`Chapter ${e}`,content:n}}async detectChapters(){if(!this.currentDocument)throw new Error("No document available");const e=[],t=this.currentDocument.pages;let n=1,i=1,s="";for(let o=0;o<t.length;o++){const r=t[o];s+=r.text+"\n\n",((o+1)%5==0||this.isChapterStart(r.text))&&(e.push({startPage:i,endPage:r.pageNumber,title:`Chapter ${n}`,content:s.trim()}),n++,i=r.pageNumber+1,s="")}return s.trim()&&e.push({startPage:i,endPage:t[t.length-1].pageNumber,title:`Chapter ${n}`,content:s.trim()}),e}isChapterStart(e){return[/^chapter\s+\d+/i,/^section\s+\d+/i,/^\d+\.\s+[A-Z]/,/^[A-Z][A-Z\s]+$/m].some(t=>t.test(e))}async generateComparativeSummary(e,t){const n=e.map(e=>`${e.title}:\n${e.content}`).join("\n\n"),i=`Create a comparative summary of the following sections, highlighting similarities, differences, and relationships between them.\n\n${this.getStyleInstructions(t.style)}\n\n${this.getLengthConstraint(t.maxLength)}\n\nSections:\n${n}\n\nComparative Summary:`;try{const e=await this.aiService.generateRAGResponse(i);return{id:`comparative_${Date.now()}`,content:e,metadata:{scope:"document",style:t.style,pageNumbers:[],wordCount:this.countWords(e),generatedAt:new Date,processingTime:0}}}catch(e){throw console.error("Error generating comparative summary:",e),new Error("Failed to generate comparative summary")}}exportSummary(e,t){switch(t){case"text":default:return this.exportAsText(e);case"markdown":return this.exportAsMarkdown(e);case"json":return this.exportAsJSON(e)}}exportAsText(e){let t="SUMMARY\n";return t+=`Generated: ${e.metadata.generatedAt.toLocaleString()}\n`,t+=`Scope: ${e.metadata.scope}\n`,t+=`Style: ${e.metadata.style}\n`,t+=`Word Count: ${e.metadata.wordCount}\n\n`,t+=`CONTENT\n${e.content}\n\n`,e.keyPoints&&e.keyPoints.length>0&&(t+="KEY POINTS\n",e.keyPoints.forEach((e,n)=>{t+=`${n+1}. ${e}\n`}),t+="\n"),e.definitions&&e.definitions.length>0&&(t+="DEFINITIONS\n",e.definitions.forEach(e=>{t+=`${e.term}: ${e.definition}\n`})),t}exportAsMarkdown(e){let t="# Summary\n\n";return t+=`**Generated:** ${e.metadata.generatedAt.toLocaleString()}\n`,t+=`**Scope:** ${e.metadata.scope}\n`,t+=`**Style:** ${e.metadata.style}\n`,t+=`**Word Count:** ${e.metadata.wordCount}\n\n`,t+=`## Content\n\n${e.content}\n\n`,e.keyPoints&&e.keyPoints.length>0&&(t+="## Key Points\n\n",e.keyPoints.forEach((e,n)=>{t+=`${n+1}. ${e}\n`}),t+="\n"),e.definitions&&e.definitions.length>0&&(t+="## Definitions\n\n",e.definitions.forEach(e=>{t+=`**${e.term}:** ${e.definition}\n\n`})),t}exportAsJSON(e){return JSON.stringify(e,null,2)}countWords(e){return e.trim().split(/\s+/).length}getAvailableScopes(){return this.currentDocument?[{value:"page",label:"Current Page",description:"Summarize the current page only"},{value:"chapter",label:"Current Chapter",description:"Summarize the current chapter or section"},{value:"document",label:"Entire Document",description:"Summarize the complete document"},{value:"selection",label:"Selected Text",description:"Summarize only the selected text"}]:[]}getAvailableStyles(){return[{value:"brief",label:"Brief",description:"Concise summary focusing on key points"},{value:"detailed",label:"Detailed",description:"Comprehensive summary with thorough explanations"},{value:"bullet-points",label:"Bullet Points",description:"Organized summary in bullet-point format"},{value:"academic",label:"Academic",description:"Formal academic-style summary"}]}}class c{constructor(e,t){this.container=null,this.isVisible=!1,this.config=e,this.summaryService=t}initialize(){this.createUI(),this.setupEventListeners()}createUI(){const e=document.getElementById(this.config.containerId);e&&e.remove(),this.container=document.createElement("div"),this.container.id=this.config.containerId,this.container.className="summary-generator",this.container.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 500px;\n      max-width: 90vw;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\n      z-index: 10001;\n      display: none;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      overflow: hidden;\n    ",this.createHeader(),this.createForm(),this.createActions(),document.body.appendChild(this.container)}createHeader(){const e=document.createElement("div");e.style.cssText="\n      padding: 20px 24px 16px;\n      border-bottom: 1px solid #e0e0e0;\n      background: #f8f9fa;\n    ";const t=document.createElement("h2");t.textContent="Generate Summary",t.style.cssText="\n      margin: 0;\n      font-size: 20px;\n      font-weight: 600;\n      color: #333;\n    ";const n=document.createElement("p");n.textContent="Create a summary of your document with AI assistance",n.style.cssText="\n      margin: 8px 0 0 0;\n      font-size: 14px;\n      color: #666;\n    ",e.appendChild(t),e.appendChild(n),this.container.appendChild(e)}createForm(){const e=document.createElement("div");e.style.cssText="\n      padding: 24px;\n    ";const t=this.createSelectSection("scope","Summary Scope","Choose what content to summarize",[{value:"page",label:"Current Page"},{value:"chapter",label:"Current Chapter"},{value:"document",label:"Entire Document"},{value:"selection",label:"Selected Text"}]),n=this.createSelectSection("style","Summary Style","Choose the format and tone",[{value:"brief",label:"Brief"},{value:"detailed",label:"Detailed"},{value:"bullet-points",label:"Bullet Points"},{value:"academic",label:"Academic"}]),i=this.createSelectSection("maxLength","Maximum Length","Control the summary length",[{value:"100",label:"Very Brief (100 words)"},{value:"300",label:"Brief (300 words)"},{value:"500",label:"Moderate (500 words)"},{value:"1000",label:"Comprehensive (1000 words)"}]),s=this.createOptionsSection();e.appendChild(t),e.appendChild(n),e.appendChild(i),e.appendChild(s),this.container.appendChild(e)}createSelectSection(e,t,n,i){const s=document.createElement("div");s.style.cssText="\n      margin-bottom: 20px;\n    ";const o=document.createElement("label");o.textContent=t,o.style.cssText="\n      display: block;\n      font-size: 14px;\n      font-weight: 600;\n      color: #333;\n      margin-bottom: 4px;\n    ";const r=document.createElement("p");r.textContent=n,r.style.cssText="\n      margin: 0 0 8px 0;\n      font-size: 12px;\n      color: #666;\n    ";const a=document.createElement("select");return a.name=e,a.style.cssText="\n      width: 100%;\n      padding: 10px 12px;\n      border: 1px solid #e0e0e0;\n      border-radius: 6px;\n      font-size: 14px;\n      background: white;\n      outline: none;\n      transition: border-color 0.2s ease;\n    ",a.addEventListener("focus",()=>{a.style.borderColor="#1a73e8"}),a.addEventListener("blur",()=>{a.style.borderColor="#e0e0e0"}),i.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,a.appendChild(t)}),s.appendChild(o),s.appendChild(r),s.appendChild(a),s}createOptionsSection(){const e=document.createElement("div");e.style.cssText="\n      margin-bottom: 20px;\n    ";const t=document.createElement("label");return t.textContent="Additional Features",t.style.cssText="\n      display: block;\n      font-size: 14px;\n      font-weight: 600;\n      color: #333;\n      margin-bottom: 8px;\n    ",[{name:"includeKeyPoints",label:"Include Key Points",description:"Extract main points as a list"},{name:"includeDefinitions",label:"Include Definitions",description:"Extract important terms and definitions"}].forEach(t=>{const n=document.createElement("div");n.style.cssText="\n        display: flex;\n        align-items: flex-start;\n        gap: 8px;\n        margin-bottom: 8px;\n      ";const i=document.createElement("input");i.type="checkbox",i.name=t.name,i.id=t.name,i.style.cssText="\n        margin-top: 2px;\n      ";const s=document.createElement("div");s.style.cssText="\n        flex: 1;\n      ";const o=document.createElement("label");o.htmlFor=t.name,o.textContent=t.label,o.style.cssText="\n        font-size: 14px;\n        font-weight: 500;\n        color: #333;\n        cursor: pointer;\n        display: block;\n      ";const r=document.createElement("p");r.textContent=t.description,r.style.cssText="\n        margin: 2px 0 0 0;\n        font-size: 12px;\n        color: #666;\n      ",s.appendChild(o),s.appendChild(r),n.appendChild(i),n.appendChild(s),e.appendChild(n)}),e.insertBefore(t,e.firstChild),e}createActions(){const e=document.createElement("div");e.style.cssText="\n      padding: 16px 24px;\n      border-top: 1px solid #e0e0e0;\n      background: #f8f9fa;\n      display: flex;\n      gap: 12px;\n      justify-content: flex-end;\n    ";const t=document.createElement("button");t.textContent="Cancel",t.style.cssText="\n      padding: 10px 16px;\n      background: transparent;\n      color: #666;\n      border: 1px solid #e0e0e0;\n      border-radius: 6px;\n      font-size: 14px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",t.addEventListener("click",()=>this.hide()),t.addEventListener("mouseenter",()=>{t.style.background="#f0f0f0"}),t.addEventListener("mouseleave",()=>{t.style.background="transparent"});const n=document.createElement("button");n.textContent="Generate Summary",n.style.cssText="\n      padding: 10px 20px;\n      background: #1a73e8;\n      color: white;\n      border: none;\n      border-radius: 6px;\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: background-color 0.2s ease;\n    ",n.addEventListener("click",()=>this.generateSummary()),n.addEventListener("mouseenter",()=>{n.style.background="#1557b0"}),n.addEventListener("mouseleave",()=>{n.style.background="#1a73e8"}),e.appendChild(t),e.appendChild(n),this.container.appendChild(e)}setupEventListeners(){document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isVisible&&this.hide()}),document.addEventListener("click",e=>{this.isVisible&&this.container&&!this.container.contains(e.target)&&this.hide()})}show(){this.container&&(this.container.style.display="block",this.isVisible=!0,this.addBackdrop())}hide(){this.container&&(this.container.style.display="none",this.isVisible=!1,this.removeBackdrop())}addBackdrop(){const e=document.createElement("div");e.id="summary-generator-backdrop",e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n      z-index: 10000;\n    ",e.addEventListener("click",()=>this.hide()),document.body.appendChild(e)}removeBackdrop(){const e=document.getElementById("summary-generator-backdrop");e&&e.remove()}async generateSummary(){if(!this.container)return;const e=this.getFormData();if(e){this.setLoadingState(!0);try{const t=await this.summaryService.generateSummary(e);this.config.onSummaryGenerated(t),this.hide()}catch(e){console.error("Error generating summary:",e),this.config.onError(e instanceof Error?e.message:"Failed to generate summary")}finally{this.setLoadingState(!1)}}}getFormData(){if(!this.container)return null;const e=this.container.querySelector('select[name="scope"]')?.value,t=this.container.querySelector('select[name="style"]')?.value,n=parseInt(this.container.querySelector('select[name="maxLength"]')?.value||"500"),i=this.container.querySelector('input[name="includeKeyPoints"]')?.checked||!1,s=this.container.querySelector('input[name="includeDefinitions"]')?.checked||!1;return e&&t?{scope:e,style:t,includeKeyPoints:i,includeDefinitions:s,maxLength:n,language:"en"}:(this.config.onError("Please fill in all required fields"),null)}setLoadingState(e){if(!this.container)return;const t=this.container.querySelector("button:last-child");t&&(e?(t.textContent="Generating...",t.disabled=!0,t.style.background="#ccc"):(t.textContent="Generate Summary",t.disabled=!1,t.style.background="#1a73e8"))}updateAvailableScopes(){if(!this.container)return;const e=this.container.querySelector('select[name="scope"]');if(!e)return;const t=this.summaryService.getAvailableScopes();e.innerHTML="",t.forEach(t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.label,e.appendChild(n)})}}class l{constructor(e){this.currentDocument=null,this.activeSession=null,this.quizHistory=[],this.aiService=e}setDocument(e){this.currentDocument=e,console.log("Document set for quiz service:",e.title)}async generateQuiz(e,t){if(!this.currentDocument)throw new Error("No document available for quiz generation");try{let n="",i=[];switch(e.scope){case"page":n=await this.getPageContent(1),i=[1];break;case"chapter":const e=await this.getChapterContent(1);n=e.content,i=Array.from({length:e.endPage-e.startPage+1},(t,n)=>e.startPage+n);break;case"document":n=this.currentDocument.pages.map(e=>e.text).join("\n\n"),i=this.currentDocument.pages.map(e=>e.pageNumber);break;case"selection":if(!t)throw new Error("Selection text is required for selection-based quiz");n=t,i=[1]}return await this.generateQuestions(n,e,i)}catch(e){throw console.error("Error generating quiz:",e),new Error(`Failed to generate quiz: ${e instanceof Error?e.message:"Unknown error"}`)}}async generateQuestions(e,t,n){const i=this.buildQuizPrompt(e,t);try{const e=await this.aiService.generateRAGResponse(i),s=this.parseQuestions(e,t,n);return(await this.enhanceQuestions(s,t)).slice(0,t.questionCount)}catch(e){throw console.error("Error generating questions:",e),new Error("Failed to generate quiz questions")}}buildQuizPrompt(e,t){const n=this.getDifficultyInstructions(t.difficulty),i=this.getQuestionTypeInstructions(t.questionTypes);return`Generate ${t.questionCount} ${t.difficulty} difficulty quiz questions based on the following content.\n\n${n}\n\n${i}\n\nRequirements:\n- Each question should have exactly 4 options (A, B, C, D)\n- Only one correct answer per question\n- Make distractors plausible but clearly incorrect\n- Questions should test understanding, not just memorization\n- Include explanations for correct answers\n- Include helpful hints for difficult questions\n\n${t.includeExplanations?"- Provide detailed explanations for why the correct answer is right":""}\n${t.includeHints?"- Include helpful hints for each question":""}\n\nContent:\n${e}\n\nPlease format your response as a JSON array with the following structure:\n[\n  {\n    "question": "Question text here?",\n    "options": ["Option A", "Option B", "Option C", "Option D"],\n    "correctAnswer": 0,\n    "explanation": "Explanation of why this is correct",\n    "hint": "Helpful hint for the question",\n    "difficulty": "${t.difficulty}",\n    "questionType": "multiple-choice"\n  }\n]`}getDifficultyInstructions(e){switch(e){case"easy":return"Create straightforward questions that test basic understanding and recall of key concepts.";case"medium":return"Create questions that require application of concepts and moderate critical thinking.";case"hard":return"Create challenging questions that require deep understanding, analysis, and synthesis of concepts.";default:return"Create questions appropriate for the specified difficulty level."}}getQuestionTypeInstructions(e){const t=[];return e.includes("multiple-choice")&&t.push("Focus on traditional multiple choice questions with 4 options."),e.includes("true-false")&&t.push("Include some true/false questions with clear, unambiguous statements."),e.includes("fill-blank")&&t.push("Include fill-in-the-blank style questions with multiple choice options."),t.join(" ")}parseQuestions(e,t,n){try{const i=JSON.parse(e),s=[];for(let e=0;e<i.length;e++){const o=i[e];if(o.question&&o.options&&Array.isArray(o.options)&&4===o.options.length){const i={id:`quiz_${Date.now()}_${e}`,question:o.question,options:o.options,correctAnswer:o.correctAnswer||0,explanation:o.explanation,hint:o.hint,difficulty:o.difficulty||t.difficulty,questionType:o.questionType||"multiple-choice",metadata:{scope:t.scope,pageNumbers:n,generatedAt:new Date}};s.push(i)}}return s}catch(e){return console.warn("Failed to parse quiz questions as JSON, creating fallback questions"),this.createFallbackQuestions(t,n)}}createFallbackQuestions(e,t){const n=[];for(let i=0;i<e.questionCount;i++)n.push({id:`fallback_${Date.now()}_${i}`,question:`Question ${i+1} about the content?`,options:["Option A","Option B","Option C","Option D"],correctAnswer:0,explanation:"This is a fallback question due to parsing issues.",hint:"Review the content carefully.",difficulty:e.difficulty,questionType:"multiple-choice",metadata:{scope:e.scope,pageNumbers:t,generatedAt:new Date}});return n}async enhanceQuestions(e,t){const n=[];for(const i of e){let e={...i};t.includeExplanations&&!i.explanation&&(e.explanation=await this.generateExplanation(i)),t.includeHints&&!i.hint&&(e.hint=await this.generateHint(i)),this.validateQuestion(e)&&n.push(e)}return n}async generateExplanation(e){const t=`Explain why the correct answer is right for this question:\n\nQuestion: ${e.question}\nOptions: ${e.options.join(", ")}\nCorrect Answer: ${e.options[e.correctAnswer]}\n\nExplanation:`;try{return await this.aiService.generateRAGResponse(t)}catch(e){return"The correct answer is the most accurate option based on the content."}}async generateHint(e){const t=`Provide a helpful hint for this question without giving away the answer:\n\nQuestion: ${e.question}\nOptions: ${e.options.join(", ")}\nCorrect Answer: ${e.options[e.correctAnswer]}\n\nHint:`;try{return await this.aiService.generateRAGResponse(t)}catch(e){return"Review the relevant content carefully."}}validateQuestion(e){return!(!e.question||e.question.length<10)&&(!(!e.options||4!==e.options.length)&&(!(e.correctAnswer<0||e.correctAnswer>3)&&(4===new Set(e.options).size&&e.options.every(e=>e.length>0&&e.length<200))))}startQuiz(e,t){const n={id:`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,questions:e,currentQuestionIndex:0,answers:new Map,startTime:new Date,totalQuestions:e.length,correctAnswers:0,timeSpent:0,options:t};return this.activeSession=n,n}submitAnswer(e,t){if(!this.activeSession)throw new Error("No active quiz session");if(e>=this.activeSession.questions.length)throw new Error("Invalid question index");const n=t===this.activeSession.questions[e].correctAnswer;return this.activeSession.answers.set(e,t),n&&this.activeSession.correctAnswers++,n}nextQuestion(){if(!this.activeSession)throw new Error("No active quiz session");return this.activeSession.currentQuestionIndex<this.activeSession.questions.length-1&&(this.activeSession.currentQuestionIndex++,!0)}previousQuestion(){if(!this.activeSession)throw new Error("No active quiz session");return this.activeSession.currentQuestionIndex>0&&(this.activeSession.currentQuestionIndex--,!0)}completeQuiz(){if(!this.activeSession)throw new Error("No active quiz session");const e=new Date,t=(e.getTime()-this.activeSession.startTime.getTime())/1e3,n=this.activeSession.correctAnswers/this.activeSession.totalQuestions*100,i={sessionId:this.activeSession.id,totalQuestions:this.activeSession.totalQuestions,correctAnswers:this.activeSession.correctAnswers,score:n,timeSpent:t,averageTimePerQuestion:t/this.activeSession.totalQuestions,difficulty:this.activeSession.options.difficulty,completedAt:e,questionResults:this.generateQuestionResults()};return this.quizHistory.push(i),this.activeSession=null,i}generateQuestionResults(){if(!this.activeSession)return[];const e=[];for(let t=0;t<this.activeSession.questions.length;t++){const n=this.activeSession.questions[t],i=this.activeSession.answers.get(t)??-1;e.push({questionId:n.id,userAnswer:i,correctAnswer:n.correctAnswer,isCorrect:i===n.correctAnswer,timeSpent:0})}return e}getCurrentSession(){return this.activeSession}getQuizHistory(){return[...this.quizHistory]}getQuizAnalytics(){if(0===this.quizHistory.length)return{totalQuizzesTaken:0,averageScore:0,bestScore:0,totalTimeSpent:0,questionsByDifficulty:{easy:{correct:0,total:0},medium:{correct:0,total:0},hard:{correct:0,total:0}},weakAreas:[],strongAreas:[]};const e=this.quizHistory.length,t=this.quizHistory.reduce((e,t)=>e+t.score,0)/e,n=Math.max(...this.quizHistory.map(e=>e.score)),i=this.quizHistory.reduce((e,t)=>e+t.timeSpent,0),s={easy:{correct:0,total:0},medium:{correct:0,total:0},hard:{correct:0,total:0}};return this.quizHistory.forEach(e=>{const t=e.difficulty;s[t]&&(s[t].correct+=e.correctAnswers,s[t].total+=e.totalQuestions)}),{totalQuizzesTaken:e,averageScore:t,bestScore:n,totalTimeSpent:i,questionsByDifficulty:s,weakAreas:this.identifyWeakAreas(),strongAreas:this.identifyStrongAreas()}}identifyWeakAreas(){const e=[];if(this.quizHistory.length>0){const t=this.quizHistory.slice(-5);t.reduce((e,t)=>e+t.score,0)/t.length<70&&e.push("Recent performance suggests need for review")}return e}identifyStrongAreas(){const e=[];if(this.quizHistory.length>0){const t=this.quizHistory.slice(-5);t.reduce((e,t)=>e+t.score,0)/t.length>85&&e.push("Strong recent performance")}return e}async getPageContent(e){if(!this.currentDocument)throw new Error("No document available");const t=this.currentDocument.pages.find(t=>t.pageNumber===e);if(!t)throw new Error(`Page ${e} not found`);return t.text||""}async getChapterContent(e){if(!this.currentDocument)throw new Error("No document available");const t=Math.min(5,this.currentDocument.pages.length);return{content:this.currentDocument.pages.filter(e=>e.pageNumber>=1&&e.pageNumber<=t).map(e=>e.text).join("\n\n"),startPage:1,endPage:t}}exportQuizResults(e,t){switch(t){case"text":default:return this.exportAsText(e);case"json":return this.exportAsJSON(e);case"csv":return this.exportAsCSV(e)}}exportAsText(e){let t="QUIZ RESULTS\n";return t+=`Session ID: ${e.sessionId}\n`,t+=`Completed: ${e.completedAt.toLocaleString()}\n`,t+=`Score: ${e.score.toFixed(1)}%\n`,t+=`Correct Answers: ${e.correctAnswers}/${e.totalQuestions}\n`,t+=`Time Spent: ${e.timeSpent.toFixed(1)} seconds\n`,t+=`Average Time per Question: ${e.averageTimePerQuestion.toFixed(1)} seconds\n\n`,t+="QUESTION RESULTS:\n",e.questionResults.forEach((e,n)=>{t+=`${n+1}. ${e.isCorrect?"✓":"✗"} (${e.timeSpent.toFixed(1)}s)\n`}),t}exportAsJSON(e){return JSON.stringify(e,null,2)}exportAsCSV(e){let t="Question,User Answer,Correct Answer,Is Correct,Time Spent\n";return e.questionResults.forEach((e,n)=>{t+=`${n+1},${e.userAnswer},${e.correctAnswer},${e.isCorrect},${e.timeSpent}\n`}),t}}class d{constructor(e,t){this.container=null,this.isVisible=!1,this.config=e,this.quizService=t}initialize(){this.createUI(),this.setupEventListeners()}createUI(){const e=document.getElementById(this.config.containerId);e&&e.remove(),this.container=document.createElement("div"),this.container.id=this.config.containerId,this.container.className="quiz-generator",this.container.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 500px;\n      max-width: 90vw;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\n      z-index: 10001;\n      display: none;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      overflow: hidden;\n    ",this.createHeader(),this.createForm(),this.createActions(),document.body.appendChild(this.container)}createHeader(){const e=document.createElement("div");e.style.cssText="\n      padding: 20px 24px 16px;\n      border-bottom: 1px solid #e0e0e0;\n      background: #f8f9fa;\n    ";const t=document.createElement("h2");t.textContent="Generate Quiz",t.style.cssText="\n      margin: 0;\n      font-size: 20px;\n      font-weight: 600;\n      color: #333;\n    ";const n=document.createElement("p");n.textContent="Create a quiz to test your understanding of the document",n.style.cssText="\n      margin: 8px 0 0 0;\n      font-size: 14px;\n      color: #666;\n    ",e.appendChild(t),e.appendChild(n),this.container.appendChild(e)}createForm(){const e=document.createElement("div");e.style.cssText="\n      padding: 24px;\n    ";const t=this.createSelectSection("scope","Quiz Scope","Choose what content to quiz on",[{value:"page",label:"Current Page"},{value:"chapter",label:"Current Chapter"},{value:"document",label:"Entire Document"},{value:"selection",label:"Selected Text"}]),n=this.createSelectSection("difficulty","Difficulty Level","Choose the difficulty of questions",[{value:"easy",label:"Easy"},{value:"medium",label:"Medium"},{value:"hard",label:"Hard"}]),i=this.createSelectSection("questionCount","Number of Questions","How many questions to generate",[{value:"5",label:"5 Questions"},{value:"10",label:"10 Questions"},{value:"15",label:"15 Questions"},{value:"20",label:"20 Questions"}]),s=this.createMultiSelectSection("questionTypes","Question Types","Select types of questions to include",[{value:"multiple-choice",label:"Multiple Choice"},{value:"true-false",label:"True/False"},{value:"fill-blank",label:"Fill in the Blank"}]),o=this.createOptionsSection();e.appendChild(t),e.appendChild(n),e.appendChild(i),e.appendChild(s),e.appendChild(o),this.container.appendChild(e)}createSelectSection(e,t,n,i){const s=document.createElement("div");s.style.cssText="\n      margin-bottom: 20px;\n    ";const o=document.createElement("label");o.textContent=t,o.style.cssText="\n      display: block;\n      font-size: 14px;\n      font-weight: 600;\n      color: #333;\n      margin-bottom: 4px;\n    ";const r=document.createElement("p");r.textContent=n,r.style.cssText="\n      margin: 0 0 8px 0;\n      font-size: 12px;\n      color: #666;\n    ";const a=document.createElement("select");return a.name=e,a.style.cssText="\n      width: 100%;\n      padding: 10px 12px;\n      border: 1px solid #e0e0e0;\n      border-radius: 6px;\n      font-size: 14px;\n      background: white;\n      outline: none;\n      transition: border-color 0.2s ease;\n    ",a.addEventListener("focus",()=>{a.style.borderColor="#1a73e8"}),a.addEventListener("blur",()=>{a.style.borderColor="#e0e0e0"}),i.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,a.appendChild(t)}),s.appendChild(o),s.appendChild(r),s.appendChild(a),s}createMultiSelectSection(e,t,n,i){const s=document.createElement("div");s.style.cssText="\n      margin-bottom: 20px;\n    ";const o=document.createElement("label");o.textContent=t,o.style.cssText="\n      display: block;\n      font-size: 14px;\n      font-weight: 600;\n      color: #333;\n      margin-bottom: 4px;\n    ";const r=document.createElement("p");r.textContent=n,r.style.cssText="\n      margin: 0 0 8px 0;\n      font-size: 12px;\n      color: #666;\n    ";const a=document.createElement("div");return a.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    ",i.forEach(t=>{const n=document.createElement("div");n.style.cssText="\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      ";const i=document.createElement("input");i.type="checkbox",i.name=`${e}_${t.value}`,i.id=`${e}_${t.value}`,i.value=t.value,i.checked="multiple-choice"===t.value,i.style.cssText="\n        margin: 0;\n      ";const s=document.createElement("label");s.htmlFor=`${e}_${t.value}`,s.textContent=t.label,s.style.cssText="\n        font-size: 14px;\n        color: #333;\n        cursor: pointer;\n        margin: 0;\n      ",n.appendChild(i),n.appendChild(s),a.appendChild(n)}),s.appendChild(o),s.appendChild(r),s.appendChild(a),s}createOptionsSection(){const e=document.createElement("div");e.style.cssText="\n      margin-bottom: 20px;\n    ";const t=document.createElement("label");return t.textContent="Additional Features",t.style.cssText="\n      display: block;\n      font-size: 14px;\n      font-weight: 600;\n      color: #333;\n      margin-bottom: 8px;\n    ",[{name:"includeExplanations",label:"Include Explanations",description:"Show explanations for correct answers"},{name:"includeHints",label:"Include Hints",description:"Provide helpful hints for questions"}].forEach(t=>{const n=document.createElement("div");n.style.cssText="\n        display: flex;\n        align-items: flex-start;\n        gap: 8px;\n        margin-bottom: 8px;\n      ";const i=document.createElement("input");i.type="checkbox",i.name=t.name,i.id=t.name,i.checked=!0,i.style.cssText="\n        margin-top: 2px;\n      ";const s=document.createElement("div");s.style.cssText="\n        flex: 1;\n      ";const o=document.createElement("label");o.htmlFor=t.name,o.textContent=t.label,o.style.cssText="\n        font-size: 14px;\n        font-weight: 500;\n        color: #333;\n        cursor: pointer;\n        display: block;\n      ";const r=document.createElement("p");r.textContent=t.description,r.style.cssText="\n        margin: 2px 0 0 0;\n        font-size: 12px;\n        color: #666;\n      ",s.appendChild(o),s.appendChild(r),n.appendChild(i),n.appendChild(s),e.appendChild(n)}),e.insertBefore(t,e.firstChild),e}createActions(){const e=document.createElement("div");e.style.cssText="\n      padding: 16px 24px;\n      border-top: 1px solid #e0e0e0;\n      background: #f8f9fa;\n      display: flex;\n      gap: 12px;\n      justify-content: flex-end;\n    ";const t=document.createElement("button");t.textContent="Cancel",t.style.cssText="\n      padding: 10px 16px;\n      background: transparent;\n      color: #666;\n      border: 1px solid #e0e0e0;\n      border-radius: 6px;\n      font-size: 14px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",t.addEventListener("click",()=>this.hide()),t.addEventListener("mouseenter",()=>{t.style.background="#f0f0f0"}),t.addEventListener("mouseleave",()=>{t.style.background="transparent"});const n=document.createElement("button");n.textContent="Generate Quiz",n.style.cssText="\n      padding: 10px 20px;\n      background: #1a73e8;\n      color: white;\n      border: none;\n      border-radius: 6px;\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: background-color 0.2s ease;\n    ",n.addEventListener("click",()=>this.generateQuiz()),n.addEventListener("mouseenter",()=>{n.style.background="#1557b0"}),n.addEventListener("mouseleave",()=>{n.style.background="#1a73e8"}),e.appendChild(t),e.appendChild(n),this.container.appendChild(e)}setupEventListeners(){document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isVisible&&this.hide()}),document.addEventListener("click",e=>{this.isVisible&&this.container&&!this.container.contains(e.target)&&this.hide()})}show(){this.container&&(this.container.style.display="block",this.isVisible=!0,this.addBackdrop())}hide(){this.container&&(this.container.style.display="none",this.isVisible=!1,this.removeBackdrop())}addBackdrop(){const e=document.createElement("div");e.id="quiz-generator-backdrop",e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n      z-index: 10000;\n    ",e.addEventListener("click",()=>this.hide()),document.body.appendChild(e)}removeBackdrop(){const e=document.getElementById("quiz-generator-backdrop");e&&e.remove()}async generateQuiz(){if(!this.container)return;const e=this.getFormData();if(e){this.setLoadingState(!0);try{const t=await this.quizService.generateQuiz(e);this.config.onQuizGenerated(t),this.hide()}catch(e){console.error("Error generating quiz:",e),this.config.onError(e instanceof Error?e.message:"Failed to generate quiz")}finally{this.setLoadingState(!1)}}}getFormData(){if(!this.container)return null;const e=this.container.querySelector('select[name="scope"]')?.value,t=this.container.querySelector('select[name="difficulty"]')?.value,n=parseInt(this.container.querySelector('select[name="questionCount"]')?.value||"10"),i=this.container.querySelector('input[name="includeExplanations"]')?.checked||!1,s=this.container.querySelector('input[name="includeHints"]')?.checked||!1,o=[];return this.container.querySelectorAll('input[name^="questionTypes_"]').forEach(e=>{e.checked&&o.push(e.value)}),e&&t&&0!==o.length?{scope:e,difficulty:t,questionCount:n,includeExplanations:i,includeHints:s,questionTypes:o}:(this.config.onError("Please fill in all required fields"),null)}setLoadingState(e){if(!this.container)return;const t=this.container.querySelector("button:last-child");t&&(e?(t.textContent="Generating...",t.disabled=!0,t.style.background="#ccc"):(t.textContent="Generate Quiz",t.disabled=!1,t.style.background="#1a73e8"))}}class h{constructor(e,t){this.container=null,this.isVisible=!1,this.currentSession=null,this.questionStartTime=0,this.config=e,this.quizService=t}initialize(){this.createUI(),this.setupEventListeners()}createUI(){const e=document.getElementById(this.config.containerId);e&&e.remove(),this.container=document.createElement("div"),this.container.id=this.config.containerId,this.container.className="quiz-interface",this.container.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 600px;\n      max-width: 90vw;\n      max-height: 80vh;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\n      z-index: 10001;\n      display: none;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      overflow: hidden;\n    ",document.body.appendChild(this.container)}setupEventListeners(){document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isVisible&&this.closeQuiz()})}show(){this.container&&(this.container.style.display="block",this.isVisible=!0,this.addBackdrop())}hide(){this.container&&(this.container.style.display="none",this.isVisible=!1,this.removeBackdrop())}addBackdrop(){const e=document.createElement("div");e.id="quiz-interface-backdrop",e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n      z-index: 10000;\n    ",document.body.appendChild(e)}removeBackdrop(){const e=document.getElementById("quiz-interface-backdrop");e&&e.remove()}startQuiz(e,t){this.currentSession=this.quizService.startQuiz(e,t),this.renderQuiz(),this.show()}renderQuiz(){this.container&&this.currentSession&&(this.container.innerHTML="",this.createQuizHeader(),this.createQuizContent(),this.createQuizFooter())}createQuizHeader(){if(!this.currentSession)return;const e=document.createElement("div");e.style.cssText="\n      padding: 20px 24px;\n      border-bottom: 1px solid #e0e0e0;\n      background: #f8f9fa;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    ";const t=document.createElement("h2");t.textContent=`Quiz - ${this.currentSession.options.difficulty} Difficulty`,t.style.cssText="\n      margin: 0;\n      font-size: 18px;\n      font-weight: 600;\n      color: #333;\n    ";const n=document.createElement("div");n.style.cssText="\n      font-size: 14px;\n      color: #666;\n    ",n.textContent=`Question ${this.currentSession.currentQuestionIndex+1} of ${this.currentSession.totalQuestions}`;const i=document.createElement("button");i.textContent="×",i.style.cssText="\n      background: none;\n      border: none;\n      font-size: 24px;\n      color: #666;\n      cursor: pointer;\n      padding: 0;\n      width: 30px;\n      height: 30px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 50%;\n      transition: background-color 0.2s ease;\n    ",i.addEventListener("click",()=>this.closeQuiz()),i.addEventListener("mouseenter",()=>{i.style.background="#e0e0e0"}),i.addEventListener("mouseleave",()=>{i.style.background="transparent"}),e.appendChild(t),e.appendChild(n),e.appendChild(i),this.container.appendChild(e)}createQuizContent(){if(!this.currentSession)return;const e=document.createElement("div");e.style.cssText="\n      padding: 24px;\n      max-height: 400px;\n      overflow-y: auto;\n    ";const t=this.currentSession.questions[this.currentSession.currentQuestionIndex];if(!t)return;const n=document.createElement("h3");n.textContent=t.question,n.style.cssText="\n      margin: 0 0 20px 0;\n      font-size: 16px;\n      font-weight: 500;\n      color: #333;\n      line-height: 1.5;\n    ";const i=document.createElement("div");if(i.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 12px;\n    ",t.options.forEach((e,t)=>{const n=document.createElement("button");n.textContent=`${String.fromCharCode(65+t)}. ${e}`,n.style.cssText="\n        padding: 12px 16px;\n        background: white;\n        border: 2px solid #e0e0e0;\n        border-radius: 8px;\n        text-align: left;\n        font-size: 14px;\n        color: #333;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        line-height: 1.4;\n      ";const s=this.currentSession.answers.get(this.currentSession.currentQuestionIndex);s===t&&(n.style.borderColor="#1a73e8",n.style.background="#f0f7ff"),n.addEventListener("click",()=>this.selectAnswer(t)),n.addEventListener("mouseenter",()=>{s!==t&&(n.style.borderColor="#1a73e8",n.style.background="#f8f9fa")}),n.addEventListener("mouseleave",()=>{s!==t&&(n.style.borderColor="#e0e0e0",n.style.background="white")}),i.appendChild(n)}),t.hint&&!this.currentSession.answers.has(this.currentSession.currentQuestionIndex)){const n=document.createElement("div");n.style.cssText="\n        margin-top: 20px;\n        padding: 12px;\n        background: #fff3cd;\n        border: 1px solid #ffeaa7;\n        border-radius: 6px;\n      ";const i=document.createElement("div");i.textContent="💡 Hint:",i.style.cssText="\n        font-size: 12px;\n        font-weight: 600;\n        color: #856404;\n        margin-bottom: 4px;\n      ";const s=document.createElement("div");s.textContent=t.hint,s.style.cssText="\n        font-size: 13px;\n        color: #856404;\n        line-height: 1.4;\n      ",n.appendChild(i),n.appendChild(s),e.appendChild(n)}e.appendChild(n),e.appendChild(i),this.container.appendChild(e)}createQuizFooter(){if(!this.currentSession)return;const e=document.createElement("div");e.style.cssText="\n      padding: 16px 24px;\n      border-top: 1px solid #e0e0e0;\n      background: #f8f9fa;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    ";const t=document.createElement("div");t.style.cssText="\n      display: flex;\n      gap: 12px;\n    ";const n=document.createElement("button");n.textContent="← Previous",n.style.cssText="\n      padding: 8px 16px;\n      background: transparent;\n      color: #666;\n      border: 1px solid #e0e0e0;\n      border-radius: 6px;\n      font-size: 14px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",n.disabled=0===this.currentSession.currentQuestionIndex,n.disabled?(n.style.opacity="0.5",n.style.cursor="not-allowed"):(n.addEventListener("click",()=>this.previousQuestion()),n.addEventListener("mouseenter",()=>{n.style.background="#f0f0f0"}),n.addEventListener("mouseleave",()=>{n.style.background="transparent"}));const i=document.createElement("button");i.textContent=this.currentSession.currentQuestionIndex===this.currentSession.totalQuestions-1?"Finish Quiz":"Next →",i.style.cssText="\n      padding: 8px 16px;\n      background: #1a73e8;\n      color: white;\n      border: none;\n      border-radius: 6px;\n      font-size: 14px;\n      cursor: pointer;\n      transition: background-color 0.2s ease;\n    ",i.addEventListener("click",()=>{this.currentSession.currentQuestionIndex===this.currentSession.totalQuestions-1?this.completeQuiz():this.nextQuestion()}),i.addEventListener("mouseenter",()=>{i.style.background="#1557b0"}),i.addEventListener("mouseleave",()=>{i.style.background="#1a73e8"}),t.appendChild(n),t.appendChild(i);const s=document.createElement("div");s.style.cssText="\n      display: flex;\n      gap: 4px;\n    ";for(let e=0;e<this.currentSession.totalQuestions;e++){const t=document.createElement("div");t.style.cssText=`\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        background: ${this.getProgressIndicatorColor(e)};\n        transition: background-color 0.2s ease;\n      `,s.appendChild(t)}e.appendChild(t),e.appendChild(s),this.container.appendChild(e)}getProgressIndicatorColor(e){return this.currentSession?e===this.currentSession.currentQuestionIndex?"#1a73e8":this.currentSession.answers.has(e)?"#34a853":"#e0e0e0":"#e0e0e0"}selectAnswer(e){if(!this.currentSession)return;const t=this.quizService.submitAnswer(this.currentSession.currentQuestionIndex,e);this.showAnswerFeedback(t),setTimeout(()=>{this.renderQuiz()},1500)}showAnswerFeedback(e){const t=document.createElement("div");t.style.cssText=`\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      padding: 16px 24px;\n      background: ${e?"#d4edda":"#f8d7da"};\n      color: ${e?"#155724":"#721c24"};\n      border: 1px solid ${e?"#c3e6cb":"#f5c6cb"};\n      border-radius: 8px;\n      font-size: 16px;\n      font-weight: 600;\n      z-index: 10002;\n      animation: fadeInOut 1.5s ease-in-out;\n    `,t.textContent=e?"✓ Correct!":"✗ Incorrect";const n=document.createElement("style");n.textContent="\n      @keyframes fadeInOut {\n        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }\n        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }\n      }\n    ",document.head.appendChild(n),document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t),document.head.removeChild(n)},1500)}nextQuestion(){this.currentSession&&this.quizService.nextQuestion()&&(this.currentSession=this.quizService.getCurrentSession(),this.renderQuiz())}previousQuestion(){this.currentSession&&this.quizService.previousQuestion()&&(this.currentSession=this.quizService.getCurrentSession(),this.renderQuiz())}completeQuiz(){if(!this.currentSession)return;const e=this.quizService.completeQuiz();this.showQuizResults(e)}showQuizResults(e){if(!this.container)return;this.container.innerHTML="";const t=document.createElement("div");t.style.cssText="\n      padding: 20px 24px;\n      border-bottom: 1px solid #e0e0e0;\n      background: #f8f9fa;\n      text-align: center;\n    ";const n=document.createElement("h2");n.textContent="Quiz Complete!",n.style.cssText="\n      margin: 0;\n      font-size: 20px;\n      font-weight: 600;\n      color: #333;\n    ",t.appendChild(n),this.container.appendChild(t);const i=document.createElement("div");i.style.cssText="\n      padding: 24px;\n      text-align: center;\n    ";const s=document.createElement("div");s.style.cssText="\n      margin-bottom: 24px;\n    ";const o=document.createElement("div");o.style.cssText=`\n      width: 120px;\n      height: 120px;\n      border-radius: 50%;\n      background: ${this.getScoreColor(e.score)};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin: 0 auto 16px;\n      font-size: 24px;\n      font-weight: 700;\n      color: white;\n    `,o.textContent=`${e.score.toFixed(0)}%`;const r=document.createElement("div");r.style.cssText="\n      font-size: 18px;\n      font-weight: 600;\n      color: #333;\n      margin-bottom: 8px;\n    ",r.textContent=`${e.correctAnswers} out of ${e.totalQuestions} correct`;const a=document.createElement("div");a.style.cssText="\n      font-size: 14px;\n      color: #666;\n    ",a.textContent=`Time: ${e.timeSpent.toFixed(1)}s (${e.averageTimePerQuestion.toFixed(1)}s per question)`,s.appendChild(o),s.appendChild(r),s.appendChild(a);const c=document.createElement("div");c.style.cssText=`\n      margin: 20px 0;\n      padding: 16px;\n      background: ${this.getPerformanceBackground(e.score)};\n      border-radius: 8px;\n      font-size: 16px;\n      color: ${this.getPerformanceColor(e.score)};\n    `,c.textContent=this.getPerformanceMessage(e.score);const l=document.createElement("div");l.style.cssText="\n      display: flex;\n      gap: 12px;\n      justify-content: center;\n      margin-top: 24px;\n    ";const d=document.createElement("button");d.textContent="Review Answers",d.style.cssText="\n      padding: 10px 20px;\n      background: #1a73e8;\n      color: white;\n      border: none;\n      border-radius: 6px;\n      font-size: 14px;\n      cursor: pointer;\n      transition: background-color 0.2s ease;\n    ";const h=document.createElement("button");h.textContent="Close",h.style.cssText="\n      padding: 10px 20px;\n      background: transparent;\n      color: #666;\n      border: 1px solid #e0e0e0;\n      border-radius: 6px;\n      font-size: 14px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",d.addEventListener("click",()=>this.reviewAnswers()),h.addEventListener("click",()=>this.closeQuiz()),l.appendChild(d),l.appendChild(h),i.appendChild(s),i.appendChild(c),i.appendChild(l),this.container.appendChild(i),this.config.onQuizCompleted(e)}getScoreColor(e){return e>=90?"#28a745":e>=80?"#17a2b8":e>=70?"#ffc107":e>=60?"#fd7e14":"#dc3545"}getPerformanceBackground(e){return e>=90?"#d4edda":e>=80?"#d1ecf1":e>=70?"#fff3cd":e>=60?"#ffeaa7":"#f8d7da"}getPerformanceColor(e){return e>=90?"#155724":e>=80?"#0c5460":e>=70?"#856404":e>=60?"#a17f1a":"#721c24"}getPerformanceMessage(e){return e>=90?"Excellent! You have a strong understanding of this material.":e>=80?"Great job! You have a good grasp of the concepts.":e>=70?"Good work! You understand most of the material.":e>=60?"Not bad! Consider reviewing some areas for improvement.":"Keep studying! Review the material and try again."}reviewAnswers(){alert("Review functionality will be implemented in a future update.")}closeQuiz(){this.hide(),this.currentSession=null,this.config.onQuizClosed()}}class u{constructor(){this.sidebar=null,this.isInitialized=!1,this.resizeObserver=null,this.messageQueue=[],this.currentSelection=null,this.state={isOpen:!1,isMinimized:!1,currentSession:null,isLoading:!1,error:null},this.config={width:400,maxWidth:600,minWidth:300,position:"right",theme:"light"},this.aiService=new o,this.settingsService=r.h.getInstance(),this.summaryService=new a(this.aiService),this.quizService=new l(this.aiService);const e={containerId:"learnsphere-summary-generator",onSummaryGenerated:e=>this.handleSummaryGenerated(e),onError:e=>this.setError(e)},t={containerId:"learnsphere-quiz-generator",onQuizGenerated:e=>this.handleQuizGenerated(e),onError:e=>this.setError(e)},n={containerId:"learnsphere-quiz-interface",onQuizCompleted:e=>this.handleQuizCompleted(e),onQuizClosed:()=>this.handleQuizClosed()};this.summaryGenerator=new c(e,this.summaryService),this.quizGenerator=new d(t,this.quizService),this.quizInterface=new h(n,this.quizService)}getEffectiveTheme(e){return"auto"===e?this.settingsService.getEffectiveTheme():e}async initialize(e){if(this.isInitialized)return;const t=this.settingsService.getAll();this.config={...this.config,position:t.chatSidebarPosition,width:t.chatSidebarWidth,theme:this.getEffectiveTheme(t.theme)},this.createSidebar(),this.setupEventListeners(),this.summaryGenerator.initialize(),this.quizGenerator.initialize(),this.quizInterface.initialize();const n=e||t.geminiApiKey;if(n&&this.settingsService.validateApiKey(n))try{await this.aiService.initialize(n),console.log("AI service initialized successfully")}catch(e){console.warn("Failed to initialize AI service:",e),this.setError("AI service not available. Please check your API key in settings.")}else console.warn("No valid Gemini API key found. AI features will be disabled."),this.setError("Please configure your Gemini API key in settings to enable AI features.");this.isInitialized=!0,console.log("Chat Sidebar Service initialized")}createSidebar(){const e=document.getElementById("learnsphere-chat-sidebar");e&&e.remove(),this.sidebar=document.createElement("div"),this.sidebar.id="learnsphere-chat-sidebar",this.sidebar.className="learnsphere-chat-sidebar",this.sidebar.style.cssText=`\n      position: fixed;\n      top: 0;\n      ${this.config.position}: 0;\n      width: ${this.config.width}px;\n      height: 100vh;\n      background: white;\n      border-left: 1px solid #e0e0e0;\n      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);\n      z-index: 10000;\n      display: flex;\n      flex-direction: column;\n      transform: translateX(${"right"===this.config.position?"100%":"-100%"});\n      transition: transform 0.3s ease;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    `,this.createSidebarHeader(),this.createChatContainer(),this.createInputArea(),document.body.appendChild(this.sidebar)}createSidebarHeader(){const e=document.createElement("div");e.className="chat-sidebar-header",e.style.cssText="\n      padding: 16px 20px;\n      border-bottom: 1px solid #e0e0e0;\n      background: #f8f9fa;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      flex-shrink: 0;\n    ";const t=document.createElement("h2");t.textContent="LearnSphere Chat",t.style.cssText="\n      margin: 0;\n      font-size: 18px;\n      font-weight: 600;\n      color: #333;\n    ";const n=document.createElement("div");n.style.cssText="\n      display: flex;\n      gap: 8px;\n      align-items: center;\n    ";const i=this.createIconButton("📝",()=>this.showSummaryGenerator());i.title="Generate Summary";const s=this.createIconButton("🧠",()=>this.showQuizGenerator());s.title="Generate Quiz";const o=this.createIconButton("−",()=>this.toggleMinimize());o.title="Minimize";const r=this.createIconButton("×",()=>this.close());r.title="Close";const a=document.createElement("div");a.className="resize-handle",a.style.cssText=`\n      width: 4px;\n      height: 100%;\n      background: #e0e0e0;\n      cursor: col-resize;\n      position: absolute;\n      ${"right"===this.config.position?"left":"right"}: 0;\n      top: 0;\n    `,n.appendChild(i),n.appendChild(s),n.appendChild(o),n.appendChild(r),e.appendChild(t),e.appendChild(n),this.sidebar.appendChild(e),this.sidebar.appendChild(a)}createChatContainer(){const e=document.createElement("div");e.id="chat-messages-container",e.className="chat-messages-container",e.style.cssText="\n      flex: 1;\n      overflow-y: auto;\n      padding: 20px;\n      display: flex;\n      flex-direction: column;\n      gap: 16px;\n    ";const t=this.createMessage({id:"welcome",role:"assistant",content:"Hello! I'm LearnSphere, your AI study assistant. Select any text or area in the PDF and ask me questions about it. I'll help you understand the content better!",timestamp:new Date});e.appendChild(t),this.sidebar.appendChild(e)}createInputArea(){const e=document.createElement("div");e.className="chat-input-area",e.style.cssText="\n      padding: 20px;\n      border-top: 1px solid #e0e0e0;\n      background: white;\n      flex-shrink: 0;\n    ";const t=document.createElement("div");t.style.cssText="\n      display: flex;\n      gap: 12px;\n      align-items: flex-end;\n    ";const n=document.createElement("textarea");n.id="chat-input",n.placeholder="Ask a question about the selected content...",n.style.cssText="\n      flex: 1;\n      min-height: 40px;\n      max-height: 120px;\n      padding: 12px;\n      border: 1px solid #e0e0e0;\n      border-radius: 8px;\n      font-family: inherit;\n      font-size: 14px;\n      resize: vertical;\n      outline: none;\n    ";const i=document.createElement("button");i.textContent="Send",i.style.cssText="\n      padding: 12px 20px;\n      background: #1a73e8;\n      color: white;\n      border: none;\n      border-radius: 8px;\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: background-color 0.2s ease;\n    ",i.addEventListener("click",()=>this.sendMessage()),i.addEventListener("mouseenter",()=>{i.style.background="#1557b0"}),i.addEventListener("mouseleave",()=>{i.style.background="#1a73e8"}),n.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),n.addEventListener("input",()=>{n.style.height="auto",n.style.height=Math.min(n.scrollHeight,120)+"px"}),t.appendChild(n),t.appendChild(i),e.appendChild(t),this.sidebar.appendChild(e)}createIconButton(e,t){const n=document.createElement("button");return n.textContent=e,n.style.cssText="\n      width: 32px;\n      height: 32px;\n      border: none;\n      background: transparent;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 18px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: background-color 0.2s ease;\n    ",n.addEventListener("click",t),n.addEventListener("mouseenter",()=>{n.style.background="#f0f0f0"}),n.addEventListener("mouseleave",()=>{n.style.background="transparent"}),n}setupEventListeners(){this.setupResizeHandling(),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.shiftKey&&"C"===e.key&&(e.preventDefault(),this.toggle())})}setupResizeHandling(){const e=this.sidebar?.querySelector(".resize-handle");if(!e)return;let t=!1,n=0,i=0;e.addEventListener("mousedown",e=>{t=!0,n=e.clientX,i=this.config.width,document.addEventListener("mousemove",s),document.addEventListener("mouseup",o)});const s=e=>{if(!t)return;const s="right"===this.config.position?n-e.clientX:e.clientX-n,o=Math.max(this.config.minWidth,Math.min(this.config.maxWidth,i+s));this.config.width=o,this.sidebar&&(this.sidebar.style.width=o+"px")},o=()=>{t=!1,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",o)}}open(){if(!this.sidebar)return;this.state.isOpen=!0,this.sidebar.style.transform="translateX(0)";const e=document.getElementById("chat-input");e&&e.focus()}close(){if(!this.sidebar)return;this.state.isOpen=!1;const e="right"===this.config.position?"100%":"-100%";this.sidebar.style.transform=`translateX(${e})`}toggle(){this.state.isOpen?this.close():this.open()}toggleMinimize(){this.state.isMinimized=!this.state.isMinimized,this.state.isMinimized?(this.sidebar.style.height="60px",this.sidebar.style.overflow="hidden"):(this.sidebar.style.height="100vh",this.sidebar.style.overflow="visible")}async sendMessage(){const e=document.getElementById("chat-input");if(!e||!e.value.trim())return;const t=e.value.trim();e.value="",e.style.height="auto";const n={id:this.generateMessageId(),role:"user",content:t,timestamp:new Date};this.addMessage(n),this.setLoading(!0);try{const e=await this.aiService.generateRAGResponse(t,this.currentSelection||void 0),n={id:this.generateMessageId(),role:"assistant",content:e,timestamp:new Date};this.addMessage(n)}catch(e){console.error("Error getting AI response:",e),this.setError("Failed to get response. Please try again.")}finally{this.setLoading(!1)}}setDocumentContext(e){this.aiService.setDocumentContext(e),this.summaryService.setDocument(e),this.quizService.setDocument(e)}setCurrentSelection(e){this.currentSelection=e}async initializeAI(e){try{await this.aiService.initialize(e),console.log("AI service initialized successfully")}catch(e){throw console.error("Failed to initialize AI service:",e),e}}getAIStatus(){return this.aiService.getStatus()}showSummaryGenerator(){this.summaryGenerator.show()}showQuizGenerator(){this.quizGenerator.show()}handleSummaryGenerated(e){const t={id:`summary_${Date.now()}`,role:"assistant",content:this.formatSummaryForChat(e),timestamp:new Date};this.addMessage(t)}handleQuizGenerated(e){this.quizInterface.startQuiz(e,{difficulty:"medium",questionCount:e.length})}handleQuizCompleted(e){const t={id:`quiz_${Date.now()}`,role:"assistant",content:this.formatQuizResultsForChat(e),timestamp:new Date};this.addMessage(t)}handleQuizClosed(){console.log("Quiz interface closed")}formatSummaryForChat(e){let t="📝 **Summary Generated**\n\n";return t+=`**Scope:** ${e.metadata.scope}\n`,t+=`**Style:** ${e.metadata.style}\n`,t+=`**Word Count:** ${e.metadata.wordCount}\n\n`,t+=`**Content:**\n${e.content}\n\n`,e.keyPoints&&e.keyPoints.length>0&&(t+="**Key Points:**\n",e.keyPoints.forEach((e,n)=>{t+=`${n+1}. ${e}\n`}),t+="\n"),e.definitions&&e.definitions.length>0&&(t+="**Definitions:**\n",e.definitions.forEach(e=>{t+=`• **${e.term}:** ${e.definition}\n`})),t}formatQuizResultsForChat(e){let t="🧠 **Quiz Results**\n\n";return t+=`**Score:** ${e.score.toFixed(1)}%\n`,t+=`**Correct Answers:** ${e.correctAnswers}/${e.totalQuestions}\n`,t+=`**Time Spent:** ${e.timeSpent.toFixed(1)}s\n`,t+=`**Average Time per Question:** ${e.averageTimePerQuestion.toFixed(1)}s\n`,t+=`**Difficulty:** ${e.difficulty}\n\n`,t+=`**Performance:** ${this.getQuizPerformanceMessage(e.score)}\n\n`,t+="**Question Results:**\n",e.questionResults.forEach((e,n)=>{const i=e.isCorrect?"✓":"✗";t+=`${n+1}. ${i} (${e.timeSpent.toFixed(1)}s)\n`}),t}getQuizPerformanceMessage(e){return e>=90?"Excellent! You have a strong understanding of this material.":e>=80?"Great job! You have a good grasp of the concepts.":e>=70?"Good work! You understand most of the material.":e>=60?"Not bad! Consider reviewing some areas for improvement.":"Keep studying! Review the material and try again."}addMessage(e){const t=document.getElementById("chat-messages-container");if(!t)return;const n=this.createMessage(e);t.appendChild(n),t.scrollTop=t.scrollHeight}createMessage(e){const t=document.createElement("div");t.className=`chat-message ${e.role}`,t.style.cssText="\n      display: flex;\n      gap: 12px;\n      align-items: flex-start;\n      animation: messageSlideIn 0.3s ease;\n    ";const n=document.createElement("div");n.className="message-avatar",n.style.cssText="\n      width: 32px;\n      height: 32px;\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 14px;\n      font-weight: 600;\n      flex-shrink: 0;\n    ","user"===e.role?(n.textContent="👤",n.style.background="#1a73e8",n.style.color="white"):(n.textContent="🤖",n.style.background="#f0f0f0",n.style.color="#333");const i=document.createElement("div");i.className="message-content",i.style.cssText=`\n      flex: 1;\n      background: ${"user"===e.role?"#1a73e8":"#f8f9fa"};\n      color: ${"user"===e.role?"white":"#333"};\n      padding: 12px 16px;\n      border-radius: 12px;\n      font-size: 14px;\n      line-height: 1.5;\n      word-wrap: break-word;\n    `,i.textContent=e.content;const s=document.createElement("div");return s.className="message-timestamp",s.style.cssText=`\n      font-size: 11px;\n      color: #999;\n      margin-top: 4px;\n      text-align: ${"user"===e.role?"right":"left"};\n    `,s.textContent=this.formatTimestamp(e.timestamp),i.appendChild(s),t.appendChild(n),t.appendChild(i),t}setLoading(e){this.state.isLoading=e;const t=this.sidebar?.querySelector("button");t&&(e?(t.textContent="...",t.disabled=!0):(t.textContent="Send",t.disabled=!1))}setError(e){this.state.error=e;const t={id:this.generateMessageId(),role:"assistant",content:`❌ ${e}`,timestamp:new Date};this.addMessage(t)}openWithSelection(e){this.open(),this.setCurrentSelection(e);const t=document.getElementById("chat-input");t&&(t.placeholder="text"in e?`Ask about: "${e.text.substring(0,50)}${e.text.length>50?"...":""}"`:"Ask about the selected area...",t.focus())}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}formatTimestamp(e){return e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}getState(){return{...this.state}}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},this.sidebar&&(this.sidebar.style.width=this.config.width+"px",this.sidebar.style[this.config.position]="0")}clearHistory(){const e=document.getElementById("chat-messages-container");if(e){e.innerHTML="";const t=this.createMessage({id:"welcome",role:"assistant",content:"Hello! I'm LearnSphere, your AI study assistant. Select any text or area in the PDF and ask me questions about it. I'll help you understand the content better!",timestamp:new Date});e.appendChild(t)}}}class p{constructor(){this.selectionBox=null,this.highlightLayer=null,this.isInitialized=!1,this.state={isSelecting:!1,startX:0,startY:0,currentSelection:null,highlights:[]},this.chatSidebar=new u}initialize(){this.isInitialized||(this.createHighlightLayer(),this.setupEventListeners(),this.chatSidebar.initialize(),this.isInitialized=!0,console.log("Text Selection Service initialized"))}createHighlightLayer(){const e=document.getElementById("learnsphere-highlight-layer");e&&e.remove(),this.highlightLayer=document.createElement("div"),this.highlightLayer.id="learnsphere-highlight-layer",this.highlightLayer.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      z-index: 1000;\n    ",document.body.appendChild(this.highlightLayer)}setupEventListeners(){document.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this)),document.addEventListener("contextmenu",this.handleContextMenu.bind(this))}handleMouseDown(e){this.findPageElement(e.target)&&(this.state.isSelecting=!0,this.state.startX=e.clientX,this.state.startY=e.clientY,window.getSelection()?.removeAllRanges())}handleMouseMove(e){this.state.isSelecting&&e.altKey&&this.updateSelectionBox(e)}handleMouseUp(e){this.state.isSelecting&&(this.state.isSelecting=!1,e.altKey?this.handleAreaSelection(e):this.handleTextSelection(),this.removeSelectionBox())}handleKeyDown(e){(e.ctrlKey||e.metaKey)&&"a"===e.key&&(e.preventDefault(),this.selectAllText()),"Escape"===e.key&&this.clearSelection()}handleKeyUp(e){"Alt"===e.key&&this.removeSelectionBox()}handleSelectionChange(){const e=window.getSelection();e&&e.toString().trim()?this.showSelectionToolbar():this.hideSelectionToolbar()}handleContextMenu(e){const t=window.getSelection();t&&t.toString().trim()&&(e.preventDefault(),this.showContextMenu(e))}handleTextSelection(){const e=window.getSelection();if(!e||!e.toString().trim())return;const t=e.getRangeAt(0),n=t.getBoundingClientRect(),i=this.findPageElement(t.startContainer);if(!i)return;const s=parseInt(i.dataset.pageNumber||"1"),o={text:e.toString(),pageNumber:s,coordinates:{x:n.left,y:n.top,width:n.width,height:n.height}};this.state.currentSelection=o,this.highlightText(o),this.showSelectionPrompt(o)}handleAreaSelection(e){if(!this.selectionBox)return;const t=this.selectionBox.getBoundingClientRect(),n=this.findPageElement(e.target);if(!n)return;const i={pageNumber:parseInt(n.dataset.pageNumber||"1"),coordinates:{x:t.left,y:t.top,width:t.width,height:t.height},type:"image"};this.state.currentSelection=i,this.showSelectionPrompt(i)}updateSelectionBox(e){if(this.selectionBox||this.createSelectionBox(),this.selectionBox){const t=e.clientX,n=e.clientY,i=Math.min(this.state.startX,t),s=Math.min(this.state.startY,n),o=Math.abs(t-this.state.startX),r=Math.abs(n-this.state.startY);this.selectionBox.style.left=i+"px",this.selectionBox.style.top=s+"px",this.selectionBox.style.width=o+"px",this.selectionBox.style.height=r+"px"}}createSelectionBox(){this.selectionBox=document.createElement("div"),this.selectionBox.className="learnsphere-selection-box",this.selectionBox.style.cssText="\n      position: fixed;\n      border: 2px dashed #1a73e8;\n      background: rgba(26, 115, 232, 0.1);\n      pointer-events: none;\n      z-index: 10000;\n    ",document.body.appendChild(this.selectionBox)}removeSelectionBox(){this.selectionBox&&(document.body.removeChild(this.selectionBox),this.selectionBox=null)}highlightText(e){const t={id:this.generateHighlightId(),text:e.text,pageNumber:e.pageNumber,coordinates:e.coordinates,color:this.getNextHighlightColor(),timestamp:new Date};this.state.highlights.push(t),this.renderHighlight(t)}renderHighlight(e){if(!this.highlightLayer)return;const t=document.createElement("div");t.className="learnsphere-highlight",t.dataset.highlightId=e.id,t.style.cssText=`\n      position: absolute;\n      left: ${e.coordinates.x}px;\n      top: ${e.coordinates.y}px;\n      width: ${e.coordinates.width}px;\n      height: ${e.coordinates.height}px;\n      background: ${e.color};\n      opacity: 0.3;\n      pointer-events: none;\n      border-radius: 2px;\n    `,this.highlightLayer.appendChild(t)}showSelectionPrompt(e){const t=document.createElement("div");t.className="learnsphere-selection-prompt",t.style.cssText=`\n      position: fixed;\n      top: ${e.coordinates.y-40}px;\n      left: ${e.coordinates.x}px;\n      background: #1a73e8;\n      color: white;\n      padding: 8px 12px;\n      border-radius: 6px;\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n      z-index: 10001;\n      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n      transition: all 0.2s ease;\n      user-select: none;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    `,t.innerHTML='\n      <span>Ask LearnSphere</span>\n      <button class="highlight-btn" style="background: none; border: none; color: white; cursor: pointer; font-size: 12px;">📝</button>\n      <button class="note-btn" style="background: none; border: none; color: white; cursor: pointer; font-size: 12px;">📌</button>\n    ',t.addEventListener("click",t=>{t.target.classList.contains("highlight-btn")?this.toggleHighlight(e):t.target.classList.contains("note-btn")?this.addNote(e):this.openChat(e)}),document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},5e3)}showSelectionToolbar(){this.hideSelectionToolbar();const e=document.createElement("div");e.id="learnsphere-selection-toolbar",e.style.cssText="\n      position: fixed;\n      background: white;\n      border: 1px solid #e0e0e0;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      padding: 8px;\n      display: flex;\n      gap: 8px;\n      z-index: 10002;\n      font-size: 14px;\n    ";const t=window.getSelection();if(t){const n=t.getRangeAt(0).getBoundingClientRect();e.style.left=n.left+"px",e.style.top=n.top-50+"px"}e.innerHTML='\n      <button class="toolbar-btn highlight-btn" style="padding: 4px 8px; border: none; background: #f0f0f0; border-radius: 4px; cursor: pointer;">📝 Highlight</button>\n      <button class="toolbar-btn note-btn" style="padding: 4px 8px; border: none; background: #f0f0f0; border-radius: 4px; cursor: pointer;">📌 Note</button>\n      <button class="toolbar-btn chat-btn" style="padding: 4px 8px; border: none; background: #1a73e8; color: white; border-radius: 4px; cursor: pointer;">💬 Ask</button>\n    ',e.addEventListener("click",e=>{const t=e.target;t.classList.contains("highlight-btn")?this.toggleHighlight(this.state.currentSelection):t.classList.contains("note-btn")?this.addNote(this.state.currentSelection):t.classList.contains("chat-btn")&&this.openChat(this.state.currentSelection)}),document.body.appendChild(e)}hideSelectionToolbar(){const e=document.getElementById("learnsphere-selection-toolbar");e&&e.remove()}showContextMenu(e){const t=document.createElement("div");t.className="learnsphere-context-menu",t.style.cssText=`\n      position: fixed;\n      left: ${e.clientX}px;\n      top: ${e.clientY}px;\n      background: white;\n      border: 1px solid #e0e0e0;\n      border-radius: 6px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      padding: 4px 0;\n      z-index: 10003;\n      font-size: 14px;\n      min-width: 150px;\n    `,t.innerHTML='\n      <div class="menu-item" style="padding: 8px 12px; cursor: pointer; hover: background: #f5f5f5;">📝 Highlight</div>\n      <div class="menu-item" style="padding: 8px 12px; cursor: pointer; hover: background: #f5f5f5;">📌 Add Note</div>\n      <div class="menu-item" style="padding: 8px 12px; cursor: pointer; hover: background: #f5f5f5;">💬 Ask LearnSphere</div>\n      <div class="menu-separator" style="height: 1px; background: #e0e0e0; margin: 4px 0;"></div>\n      <div class="menu-item" style="padding: 8px 12px; cursor: pointer; hover: background: #f5f5f5;">📋 Copy</div>\n    ',t.addEventListener("click",e=>{const n=e.target;if(n.classList.contains("menu-item")){const e=n.textContent;e?.includes("Highlight")?this.toggleHighlight(this.state.currentSelection):e?.includes("Note")?this.addNote(this.state.currentSelection):e?.includes("Ask")?this.openChat(this.state.currentSelection):e?.includes("Copy")&&this.copySelection()}document.body.removeChild(t)}),document.body.appendChild(t),setTimeout(()=>{const e=()=>{document.body.contains(t)&&document.body.removeChild(t),document.removeEventListener("click",e)};document.addEventListener("click",e)},100)}toggleHighlight(e){if("text"in e){const t=this.state.highlights.find(t=>t.text===e.text&&t.pageNumber===e.pageNumber);t?this.removeHighlight(t.id):this.highlightText(e)}}removeHighlight(e){this.state.highlights=this.state.highlights.filter(t=>t.id!==e);const t=document.querySelector(`[data-highlight-id="${e}"]`);t&&t.remove()}addNote(e){const t=prompt("Add a note for this selection:");if(t){const n=this.state.highlights.find(t=>!("text"in e)||t.text===e.text);n&&(n.notes=t)}}openChat(e){this.chatSidebar.setCurrentSelection(e),this.chatSidebar.openWithSelection(e)}copySelection(){const e=window.getSelection();e&&e.toString().trim()&&navigator.clipboard.writeText(e.toString()).then(()=>{this.showToast("Text copied to clipboard")})}selectAllText(){const e=document.querySelector(".learnsphere-page");if(e){const t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n&&(n.removeAllRanges(),n.addRange(t))}}clearSelection(){window.getSelection()?.removeAllRanges(),this.hideSelectionToolbar(),this.state.currentSelection=null}findPageElement(e){let t=e;for(;t&&t!==document.body;){if(t.classList.contains("learnsphere-page"))return t;t=t.parentElement}return null}generateHighlightId(){return`highlight_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getNextHighlightColor(){const e=["#ffeb3b","#4caf50","#2196f3","#ff9800","#e91e63","#9c27b0","#00bcd4","#ff5722"];return e[this.state.highlights.length%e.length]}showToast(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: #333;\n      color: white;\n      padding: 12px 16px;\n      border-radius: 6px;\n      z-index: 10004;\n      font-size: 14px;\n    ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},3e3)}getSelectionState(){return{...this.state}}getHighlights(){return[...this.state.highlights]}clearAllHighlights(){this.state.highlights=[],this.highlightLayer&&(this.highlightLayer.innerHTML="")}exportHighlights(){return JSON.stringify(this.state.highlights,null,2)}importHighlights(e){try{const t=JSON.parse(e);this.state.highlights=t,this.highlightLayer&&(this.highlightLayer.innerHTML="",t.forEach(e=>this.renderHighlight(e)))}catch(e){console.error("Failed to import highlights:",e)}}}class m{constructor(){this.currentDocument=null,this.pdfContainer=null,this.pdfjsLib=null,this.documentProcessor=new s,this.textSelectionService=new p,this.chatSidebar=new u,this.init()}async init(){await this.loadPDFJS()}async loadPDFJS(){return new Promise(e=>{if(window.pdfjsLib)return this.pdfjsLib=window.pdfjsLib,void e();const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.onload=()=>{this.pdfjsLib=window.pdfjsLib,this.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",e()},t.onerror=()=>{console.error("Failed to load PDF.js"),e()},document.head.appendChild(t)})}async detectPDFViewer(){const e=window.location.href.toLowerCase();return e.includes("chrome-extension://")&&(document.querySelector('embed[type="application/pdf"]')||document.querySelector('object[type="application/pdf"]'))?"chrome":document.querySelector('embed[type="application/pdf"]')||document.querySelector('object[type="application/pdf"]')||document.querySelector('iframe[src*=".pdf"]')?"external":(e.includes(".pdf"),"none")}async overrideChromePDFViewer(){switch(await this.detectPDFViewer()){case"chrome":await this.overrideChromeViewer();break;case"external":await this.integrateWithExternalViewer();break;case"none":await this.createCustomViewer()}}async overrideChromeViewer(){const e=document.querySelector('embed[type="application/pdf"]');e&&(e.style.display="none"),this.createPDFContainer(),await this.loadAndRenderPDF(window.location.href)}async integrateWithExternalViewer(){this.createPDFContainer();const e=document.querySelector('iframe[src*=".pdf"]'),t=document.querySelector('embed[type="application/pdf"]'),n=document.querySelector('object[type="application/pdf"]');let i="";e&&e.src?i=e.src:t&&t.src?i=t.src:n&&n.data&&(i=n.data),i&&await this.loadAndRenderPDF(i)}async createCustomViewer(){this.createPDFContainer(),await this.loadAndRenderPDF(window.location.href)}createPDFContainer(){const e=document.getElementById("learnsphere-pdf-container");e&&e.remove(),this.pdfContainer=document.createElement("div"),this.pdfContainer.id="learnsphere-pdf-container",this.pdfContainer.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      z-index: 9999;\n      background: white;\n      overflow-y: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ";const t=this.createToolbar();this.pdfContainer.appendChild(t);const n=document.createElement("div");n.id="learnsphere-pages-container",n.style.cssText="\n      padding: 20px;\n      max-width: 800px;\n      margin: 0 auto;\n    ",this.pdfContainer.appendChild(n),document.body.appendChild(this.pdfContainer)}createToolbar(){const e=document.createElement("div");e.style.cssText="\n      position: sticky;\n      top: 0;\n      background: #f8f9fa;\n      border-bottom: 1px solid #e0e0e0;\n      padding: 12px 20px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      z-index: 1000;\n    ";const t=document.createElement("h1");t.textContent="LearnSphere PDF Viewer",t.style.cssText="\n      margin: 0;\n      font-size: 18px;\n      font-weight: 600;\n      color: #333;\n    ";const n=document.createElement("div");n.style.cssText="\n      display: flex;\n      gap: 12px;\n      align-items: center;\n    ";const i=this.createButton("−",()=>this.zoomOut()),s=this.createButton("+",()=>this.zoomIn()),o=this.createButton("Reset",()=>this.zoomReset()),r=this.createButton("←",()=>this.previousPage()),a=this.createButton("→",()=>this.nextPage()),c=document.createElement("span");c.id="page-info",c.style.cssText="\n              font-size: 14px;\n              color: #666;\n              margin: 0 8px;\n            ";const l=this.createButton("💬",()=>this.chatSidebar.toggle());l.title="Toggle Chat (Ctrl+Shift+C)",n.appendChild(i),n.appendChild(s),n.appendChild(o);const d=document.createElement("div");d.style.cssText="width: 1px; height: 20px; background: #e0e0e0; margin: 0 8px;",n.appendChild(d),n.appendChild(r),n.appendChild(c),n.appendChild(a);const h=document.createElement("div");return h.style.cssText="width: 1px; height: 20px; background: #e0e0e0; margin: 0 8px;",n.appendChild(h),n.appendChild(l),e.appendChild(t),e.appendChild(n),e}createButton(e,t){const n=document.createElement("button");return n.textContent=e,n.style.cssText="\n      padding: 8px 12px;\n      border: 1px solid #dadce0;\n      background: white;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      transition: all 0.2s ease;\n    ",n.addEventListener("click",t),n.addEventListener("mouseenter",()=>{n.style.background="#f8f9fa"}),n.addEventListener("mouseleave",()=>{n.style.background="white"}),n}async loadAndRenderPDF(e){if(this.pdfjsLib)try{this.showLoading();const t=await this.documentProcessor.processDocument(e);this.currentDocument=t.document;const n=this.pdfjsLib.getDocument(e),i=await n.promise;await this.renderAllPages(i),this.hideLoading(),this.setupInteractionHandlers(),this.textSelectionService.initialize(),await this.chatSidebar.initialize(),this.chatSidebar.setDocumentContext(this.currentDocument),console.log("Document processed successfully:",{pages:this.currentDocument.pages.length,embeddings:t.embeddings.length,images:t.images.length})}catch(e){console.error("Error loading PDF:",e),this.showError("Failed to load PDF. Please try again.")}else console.error("PDF.js not loaded")}async renderAllPages(e){const t=document.getElementById("learnsphere-pages-container");if(!t)return;const n=e.numPages;for(let i=1;i<=n;i++){const n=await e.getPage(i),s=n.getViewport({scale:1.5}),o=document.createElement("div");o.className="learnsphere-page",o.dataset.pageNumber=i.toString(),o.style.cssText="\n        background: white;\n        margin: 20px auto;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n        border-radius: 8px;\n        overflow: hidden;\n        position: relative;\n      ";const r=document.createElement("canvas"),a=r.getContext("2d");r.height=s.height,r.width=s.width,r.style.cssText="\n        display: block;\n        max-width: 100%;\n        height: auto;\n      ";const c={canvasContext:a,viewport:s};await n.render(c).promise,o.appendChild(r);const l=(await n.getTextContent()).items.map(e=>e.str).join(" ");this.currentDocument.pages.push({pageNumber:i,text:l,images:[],coordinates:{x:0,y:0,width:s.width,height:s.height}}),t.appendChild(o)}this.updatePageInfo(1,n)}setupInteractionHandlers(){this.setupKeyboardShortcuts()}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),this.saveDocument()),(e.ctrlKey||e.metaKey)&&"f"===e.key&&(e.preventDefault(),this.openSearch())})}findPageElement(e){let t=e;for(;t&&t!==document.body;){if(t instanceof Element&&t.classList.contains("learnsphere-page"))return t;t=t.parentNode}return null}showLoading(){const e=document.createElement("div");e.id="learnsphere-loading",e.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 20px;\n      border-radius: 8px;\n      z-index: 10000;\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    ",e.innerHTML='\n      <div class="loading-spinner"></div>\n      <span>Loading PDF...</span>\n    ',document.body.appendChild(e)}hideLoading(){const e=document.getElementById("learnsphere-loading");e&&e.remove()}showError(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: #dc3545;\n      color: white;\n      padding: 20px;\n      border-radius: 8px;\n      z-index: 10000;\n      text-align: center;\n    ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&t.remove()},5e3)}updatePageInfo(e,t){const n=document.getElementById("page-info");n&&(n.textContent=`${e} / ${t}`)}generateDocumentId(){return`doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}zoomIn(){console.log("Zoom in")}zoomOut(){console.log("Zoom out")}zoomReset(){console.log("Zoom reset")}previousPage(){console.log("Previous page")}nextPage(){console.log("Next page")}saveDocument(){console.log("Save document")}openSearch(){console.log("Open search")}getCurrentDocument(){return this.currentDocument}}console.log("🚀 LearnSphere: Content script file loaded successfully!"),console.log("🚀 LearnSphere: Current URL:",window.location.href),console.log("🚀 LearnSphere: Document ready state:",document.readyState),new class{constructor(){this.sidebar=null,this.isExtensionActive=!1,this.lastMouseDownPosition=null,console.log("LearnSphere: Content script constructor called"),console.log("LearnSphere: Current URL:",window.location.href),console.log("LearnSphere: Document ready state:",document.readyState),this.pdfViewerService=new m,this.settingsService=r.h.getInstance(),this.addManualActivationButton(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("LearnSphere: DOMContentLoaded, initializing..."),this.init()}):(console.log("LearnSphere: DOM already ready, initializing..."),this.init()),setTimeout(()=>{console.log("LearnSphere: Delayed initialization (1s)..."),this.init()},1e3),setTimeout(()=>{console.log("LearnSphere: Final delayed initialization (3s)..."),this.init()},3e3),window.addEventListener("load",()=>{console.log("LearnSphere: Window loaded, initializing..."),this.init()})}addManualActivationButton(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.createManualButton()):this.createManualButton()}createManualButton(){if(document.getElementById("learnsphere-manual-activate"))return;const e=document.createElement("div");e.id="learnsphere-manual-activate",e.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 20px;\n      background: linear-gradient(135deg, #ff6b6b, #ee5a24);\n      color: white;\n      padding: 12px 20px;\n      border-radius: 25px;\n      font-size: 14px;\n      font-weight: 600;\n      cursor: pointer;\n      z-index: 10003;\n      box-shadow: 0 4px 16px rgba(255, 107, 107, 0.4);\n      border: 2px solid #ffffff;\n      user-select: none;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ",e.innerHTML="🚀 Activate LearnSphere",e.addEventListener("click",()=>{console.log("LearnSphere: Manual activation button clicked"),this.manualActivate()}),document.body.appendChild(e),console.log("LearnSphere: Manual activation button added"),setTimeout(()=>{e.parentNode&&(e.parentNode.removeChild(e),console.log("LearnSphere: Manual activation button removed"))},3e4)}async init(){console.log("LearnSphere: Init method called");try{const e=this.isPDFPage();console.log("LearnSphere: Is PDF page:",e),e?(console.log("LearnSphere: PDF page detected, setting up PDF-specific features..."),await this.initializeSettings(),this.setupMessageListener(),await this.checkExistingExtensionState(),console.log("LearnSphere: PDF initialization complete")):(console.log("LearnSphere: Not a PDF page, setting up basic features..."),this.setupMessageListener(),console.log("LearnSphere: Basic initialization complete")),this.createManualButton()}catch(e){console.error("LearnSphere: Error during initialization:",e)}}initializeSettings(){this.settingsService.applySettingsToPage(),this.checkExistingExtensionState(),this.settingsService.addChangeListener(e=>{console.log("LearnSphere: Settings updated, applying to page"),this.settingsService.applySettingsToPage()})}async checkExistingExtensionState(){try{const e=this.settingsService.getGeminiApiKey();e&&this.settingsService.validateApiKey(e)&&(await this.settingsService.testApiKey(e)).valid&&(this.isExtensionActive=!0,this.enableTextSelection(),console.log("LearnSphere: Extension automatically activated on page load"))}catch(e){console.log("LearnSphere: Could not check existing extension state:",e)}}isPDFPage(){const e=window.location.href.toLowerCase(),t=document.contentType||"",n=!!(document.querySelector('embed[type="application/pdf"]')||document.querySelector('object[type="application/pdf"]')||document.querySelector('iframe[src*=".pdf"]')||document.querySelector("canvas[data-pdf-url]")),i=e.includes(".pdf")||e.includes("application/pdf")||t.includes("pdf")||n||document.title.toLowerCase().includes("pdf")||window.location.pathname.toLowerCase().includes(".pdf");return console.log("LearnSphere: PDF detection details:"),console.log("  - URL:",e),console.log("  - Content type:",t),console.log("  - Has PDF elements:",n),console.log("  - Document title:",document.title),console.log("  - Pathname:",window.location.pathname),console.log("  - Is PDF page:",i),i}async setupPDFViewer(){await this.pdfViewerService.overrideChromePDFViewer()}openSidebar(e,t){this.sidebar||this.createSidebar(),e&&(this.sidebar.dataset.selection=JSON.stringify(e)),t&&(this.sidebar.dataset.mode=t),this.sidebar.style.right="0"}createSidebar(){this.sidebar=document.createElement("div"),this.sidebar.id="learnsphere-sidebar",this.sidebar.style.cssText="\n      position: fixed;\n      top: 0;\n      right: -400px;\n      width: 400px;\n      height: 100vh;\n      background: white;\n      border-left: 1px solid #e0e0e0;\n      z-index: 10000;\n      transition: right 0.3s ease;\n      box-shadow: -2px 0 8px rgba(0,0,0,0.1);\n    ";const e=document.createElement("div");e.style.cssText="\n      padding: 16px;\n      border-bottom: 1px solid #e0e0e0;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    ";const t=document.createElement("h2");t.textContent="LearnSphere Chat",t.style.margin="0";const n=document.createElement("button");n.textContent="×",n.style.cssText="\n      background: none;\n      border: none;\n      font-size: 24px;\n      cursor: pointer;\n      color: #666;\n    ",n.addEventListener("click",()=>{this.sidebar.style.right="-400px"}),e.appendChild(t),e.appendChild(n),this.sidebar.appendChild(e);const i=document.createElement("div");i.id="learnsphere-chat",i.style.cssText="\n      flex: 1;\n      padding: 16px;\n      overflow-y: auto;\n    ",this.sidebar.appendChild(i),document.body.appendChild(this.sidebar)}setupMessageListener(){chrome.runtime.onMessage.addListener((e,t,n)=>{switch(console.log("🚀 LearnSphere: Content script received message:",e),e.action){case"ping":console.log("🚀 LearnSphere: Ping received, responding..."),n({success:!0,message:"Content script is ready!"});break;case"showNotification":console.log("🚀 LearnSphere: Showing notification:",e.message),this.showNotification(e.message,"success"),n({success:!0});break;case"activateExtension":console.log("🚀 LearnSphere: Activating extension with API key"),this.activateExtension(e.apiKey),n({success:!0});break;case"showReadyMessage":console.log("🚀 LearnSphere: Showing ready message:",e.message),this.showReadyMessage(e.message),n({success:!0});break;case"checkExtensionStatus":console.log("🚀 LearnSphere: Checking extension status"),n({active:this.isExtensionActive});break;case"contextMenuAction":console.log("🚀 LearnSphere: Handling context menu action:",e.type),this.handleContextMenuAction(e),n({success:!0});break;default:console.log("🚀 LearnSphere: Unknown message action:",e.action),n({success:!1,error:"Unknown action"})}})}handleContextMenuAction(e){const{type:t,text:n}=e;switch(t){case"chat":this.openSidebar({text:n,pageNumber:1,coordinates:{x:0,y:0,width:0,height:0}});break;case"summarize":this.openSidebar({text:n,pageNumber:1,coordinates:{x:0,y:0,width:0,height:0}},"summarize");break;case"quiz":this.openSidebar({text:n,pageNumber:1,coordinates:{x:0,y:0,width:0,height:0}},"quiz");break;case"explain":this.openSidebar({text:n,pageNumber:1,coordinates:{x:0,y:0,width:0,height:0}},"explain");break;case"pageSummary":this.getPageText().then(e=>{this.openSidebar({text:e,pageNumber:1,coordinates:{x:0,y:0,width:0,height:0}},"pageSummary")});break;case"pageQuiz":this.getPageText().then(e=>{this.openSidebar({text:e,pageNumber:1,coordinates:{x:0,y:0,width:0,height:0}},"pageQuiz")});break;default:console.error("LearnSphere: Unknown context menu action type:",t)}}async getPageText(){const e=document.querySelectorAll("p, div, span, h1, h2, h3, h4, h5, h6");let t="";return e.forEach(e=>{const n=e.textContent?.trim();n&&n.length>10&&(t+=n+"\n\n")}),t.trim()||"No text content found on this page."}async generateSummary(){const e=this.pdfViewerService.getCurrentDocument();e?console.log("Generating summary for document:",e.title):console.error("No document loaded")}async generateQuiz(){const e=this.pdfViewerService.getCurrentDocument();e?console.log("Generating quiz for document:",e.title):console.error("No document loaded")}activateExtension(e){return console.log("LearnSphere: Extension activated with API key"),this.settingsService.setGeminiApiKey(e),this.isExtensionActive=!0,this.showExtensionActiveIndicator(),this.enableTextSelection(),{success:!0,message:"Extension activated successfully"}}showReadyMessage(e){this.showNotification(e,"success")}showExtensionActiveIndicator(){const e=document.createElement("div");e.id="learnsphere-active-indicator",e.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #4caf50, #45a049);\n      color: white;\n      padding: 12px 20px;\n      border-radius: 25px;\n      font-size: 14px;\n      font-weight: 600;\n      z-index: 10001;\n      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);\n      animation: slideIn 0.5s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    ",e.innerHTML='\n      <span style="font-size: 18px;">🚀</span>\n      <span>LearnSphere Active</span>\n      <span style="font-size: 12px; opacity: 0.8;">Ready to use!</span>\n    ';const t=document.createElement("style");t.textContent="\n      @keyframes slideIn {\n        from { transform: translateX(100%); opacity: 0; }\n        to { transform: translateX(0); opacity: 1; }\n      }\n    ",document.head.appendChild(t),document.body.appendChild(e);const n=document.createElement("button");n.textContent="🧪 Test Text Selection",n.style.cssText="\n      position: fixed;\n      top: 80px;\n      right: 20px;\n      background: #ff9800;\n      color: white;\n      border: none;\n      padding: 8px 16px;\n      border-radius: 20px;\n      font-size: 12px;\n      cursor: pointer;\n      z-index: 10001;\n      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);\n    ",n.addEventListener("click",()=>{console.log("LearnSphere: Test button clicked, checking text selection..."),this.checkForTextSelection(),this.showNotification("Test button clicked! Try selecting some text in the PDF.")}),document.body.appendChild(n),setTimeout(()=>{e.parentNode&&(e.style.animation="slideOut 0.5s ease",e.style.transform="translateX(100%)",e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},500)),n.parentNode&&n.parentNode.removeChild(n)},5e3);const i=document.createElement("style");i.textContent="\n      @keyframes slideOut {\n        from { transform: translateX(0); opacity: 1; }\n        to { transform: translateX(100%); opacity: 0; }\n      }\n    ",document.head.appendChild(i)}showNotification(e,t="info"){const n=document.createElement("div");n.id="learnsphere-notification",n.style.cssText=`\n      position: fixed;\n      top: 80px;\n      right: 20px;\n      background: ${"success"===t?"#4caf50":"error"===t?"#f44336":"#2196f3"};\n      color: white;\n      padding: 12px 20px;\n      border-radius: 6px;\n      font-size: 14px;\n      max-width: 300px;\n      z-index: 10001;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n      animation: slideIn 0.3s ease;\n    `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}enableTextSelection(){console.log("LearnSphere: Enabling text selection..."),document.removeEventListener("mouseup",this.handleTextSelection.bind(this)),document.removeEventListener("keyup",this.handleTextSelection.bind(this)),document.removeEventListener("selectionchange",this.handleSelectionChange.bind(this)),document.addEventListener("mouseup",this.handleTextSelection.bind(this),!0),document.addEventListener("keyup",this.handleTextSelection.bind(this),!0),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this),!0),document.addEventListener("mousedown",this.handleMouseDown.bind(this),!0),console.log("LearnSphere: Text selection events bound successfully")}handleMouseDown(e){this.lastMouseDownPosition={x:e.clientX,y:e.clientY}}handleTextSelection(e){console.log("LearnSphere: Text selection event triggered:",e.type),this.checkForTextSelection()}handleSelectionChange(e){console.log("LearnSphere: Selection change event triggered"),this.checkForTextSelection()}checkForTextSelection(){const e=window.getSelection();console.log("LearnSphere: Checking for text selection..."),console.log("LearnSphere: Selection object:",e),e?(console.log("LearnSphere: Selection range count:",e.rangeCount),console.log("LearnSphere: Selection text:",e.toString()),e.rangeCount>0&&e.toString().trim().length>0?(console.log("LearnSphere: Valid text selection found, showing button..."),this.showSelectionActionButton(e)):console.log("LearnSphere: No valid text selection found")):console.log("LearnSphere: No selection object available")}showSelectionActionButton(e){console.log("LearnSphere: Creating selection action button...");const t=document.getElementById("learnsphere-selection-button");t&&t.remove();try{const t=e.getRangeAt(0).getBoundingClientRect();console.log("LearnSphere: Selection rectangle:",t);const n=Math.max(10,t.top-60),i=Math.max(10,Math.min(window.innerWidth-200,t.left+t.width/2)),s=document.createElement("div");s.id="learnsphere-selection-button",s.style.cssText=`\n        position: fixed;\n        top: ${n}px;\n        left: ${i}px;\n        background: linear-gradient(135deg, #1a73e8, #0d47a1);\n        color: white;\n        padding: 12px 20px;\n        border-radius: 25px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        z-index: 10002;\n        box-shadow: 0 4px 16px rgba(26, 115, 232, 0.4);\n        transform: translateX(-50%);\n        animation: fadeIn 0.3s ease;\n        border: 2px solid #ffffff;\n        white-space: nowrap;\n        user-select: none;\n      `,s.innerHTML='\n        <span style="font-size: 16px; margin-right: 8px;">💬</span>\n        <span>Chat about this</span>\n      ';const o=document.createElement("style");o.textContent="\n        @keyframes fadeIn {\n          from { opacity: 0; transform: translateX(-50%) translateY(-10px); }\n          to { opacity: 1; transform: translateX(-50%) translateY(0); }\n        }\n      ",document.head.appendChild(o),s.addEventListener("click",()=>{console.log("LearnSphere: Chat button clicked!");const n=e.toString().trim();console.log("LearnSphere: Selected text:",n),this.openSidebar({text:n,pageNumber:1,coordinates:{x:t.left,y:t.top,width:t.width,height:t.height}}),s.remove()}),s.addEventListener("mouseenter",()=>{s.style.background="linear-gradient(135deg, #0d47a1, #1a73e8)",s.style.transform="translateX(-50%) scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.style.background="linear-gradient(135deg, #1a73e8, #0d47a1)",s.style.transform="translateX(-50%) scale(1)"}),document.body.appendChild(s),console.log("LearnSphere: Selection button created and added to DOM");const r=()=>{s.parentNode&&(s.parentNode.removeChild(s),console.log("LearnSphere: Selection button removed"))};setTimeout(r,8e3);const a=()=>{const e=window.getSelection();e&&0!==e.toString().trim().length||(r(),document.removeEventListener("selectionchange",a))};document.addEventListener("selectionchange",a)}catch(e){console.error("LearnSphere: Error creating selection button:",e)}}async manualActivate(){try{console.log("LearnSphere: Manual activation started"),this.pdfViewerService||(this.pdfViewerService=new m),this.settingsService||(this.settingsService=r.h.getInstance());const e=this.settingsService.getGeminiApiKey();e&&this.settingsService.validateApiKey(e)?(console.log("LearnSphere: Valid API key found, activating extension"),this.activateExtension(e),this.showNotification("Extension activated successfully!","success")):(console.log("LearnSphere: No valid API key, opening settings"),this.showNotification("No valid API key found. Opening settings...","info"),chrome.runtime.openOptionsPage())}catch(e){console.error("LearnSphere: Manual activation failed:",e),this.showNotification("Manual activation failed. Check console for details.","error")}}}}},n={};function i(e){var s=n[e];if(void 0!==s)return s.exports;var o=n[e]={exports:{}};return t[e](o,o.exports,i),o.exports}i.m=t,e=[],i.O=(t,n,s,o)=>{if(!n){var r=1/0;for(d=0;d<e.length;d++){for(var[n,s,o]=e[d],a=!0,c=0;c<n.length;c++)(!1&o||r>=o)&&Object.keys(i.O).every(e=>i.O[e](n[c]))?n.splice(c--,1):(a=!1,o<r&&(r=o));if(a){e.splice(d--,1);var l=s();void 0!==l&&(t=l)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[n,s,o]},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={854:0};i.O.j=t=>0===e[t];var t=(t,n)=>{var s,o,[r,a,c]=n,l=0;if(r.some(t=>0!==e[t])){for(s in a)i.o(a,s)&&(i.m[s]=a[s]);if(c)var d=c(i)}for(t&&t(n);l<r.length;l++)o=r[l],i.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return i.O(d)},n=self.webpackChunklearnsphere_ce=self.webpackChunklearnsphere_ce||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var s=i.O(void 0,[329],()=>i(922));s=i.O(s)})();