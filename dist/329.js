"use strict";(self.webpackChunklearnsphere_ce=self.webpackChunklearnsphere_ce||[]).push([[329],{329:(t,e,s)=>{s.d(e,{h:()=>i});class i{constructor(){this.storageKey="learnsphere_settings",this.changeListeners=[],this.settings=this.getDefaultSettings(),this.loadSettings(),this.setupSystemThemeListener()}setupSystemThemeListener(){if("undefined"!=typeof window&&window.matchMedia){const t=window.matchMedia("(prefers-color-scheme: dark)"),e=t=>{"auto"===this.settings.theme&&this.applySettingsToPage()};t.addEventListener?t.addEventListener("change",e):t.addListener(e)}}static getInstance(){return i.instance||(i.instance=new i),i.instance}addChangeListener(t){this.changeListeners.push(t)}removeChangeListener(t){const e=this.changeListeners.indexOf(t);e>-1&&this.changeListeners.splice(e,1)}notifyListeners(){this.changeListeners.forEach(t=>{try{t(this.settings)}catch(t){console.error("Error in settings change listener:",t)}})}applySettingsToPage(){try{this.applyTheme(),this.applyAccessibilitySettings(),this.applyChatSidebarSettings(),this.notifyListeners()}catch(t){console.error("Error applying settings to page:",t)}}applyTheme(){const t=this.getThemeSettings(),e=document.documentElement;e.classList.remove("learnsphere-light","learnsphere-dark"),t.isDark?e.classList.add("learnsphere-dark"):e.classList.add("learnsphere-light"),e.style.setProperty("--learnsphere-bg-color",t.backgroundColor),e.style.setProperty("--learnsphere-text-color",t.textColor)}applyAccessibilitySettings(){const t=document.documentElement,e=this.settings.accessibilityOptions;e.highContrast?t.classList.add("learnsphere-high-contrast"):t.classList.remove("learnsphere-high-contrast"),e.largeText?t.classList.add("learnsphere-large-text"):t.classList.remove("learnsphere-large-text"),e.reduceMotion?t.classList.add("learnsphere-reduce-motion"):t.classList.remove("learnsphere-reduce-motion")}applyChatSidebarSettings(){const t=document.getElementById("learnsphere-sidebar");if(t){const e=this.getChatSidebarConfig();"left"===e.position?(t.style.left="0",t.style.right="auto"):(t.style.right="0",t.style.left="auto"),t.style.width=`${e.width}px`}}getAllSettings(){return{...this.settings}}updateSettings(t){this.settings={...this.settings,...t},this.saveSettings()}getDefaultSettings(){return{geminiApiKey:"",theme:"auto",chatSidebarPosition:"right",chatSidebarWidth:400,autoSaveHighlights:!0,enableNotifications:!0,language:"en",maxTokens:2048,temperature:.7,autoOpenChat:!1,highlightColors:["#ffeb3b","#4caf50","#2196f3","#f44336","#9c27b0"],defaultQuizDifficulty:"medium",defaultQuizQuestionCount:10,enableQuizHints:!0,enableQuizExplanations:!0,autoSaveQuizResults:!0,enableLearningAnalytics:!0,dataRetentionDays:365,enableCloudSync:!1,privacyMode:!1,accessibilityOptions:{highContrast:!1,largeText:!1,reduceMotion:!1}}}async loadSettings(){try{console.log("LearnSphere SettingsService: Loading settings from storage...");const t=await chrome.storage.sync.get(this.storageKey);console.log("LearnSphere SettingsService: Storage result:",t),t[this.storageKey]?(console.log("LearnSphere SettingsService: Found saved settings:",t[this.storageKey]),this.settings={...this.settings,...t[this.storageKey]}):console.log("LearnSphere SettingsService: No saved settings found, using defaults"),await this.migrateLegacySettings(),console.log("LearnSphere SettingsService: Final settings:",this.settings)}catch(t){console.warn("Failed to load settings from storage:",t)}}async reloadSettings(){await this.loadSettings()}async migrateLegacySettings(){try{const t=await chrome.storage.sync.get(["settings"]);if(t.settings){console.log("LearnSphere: Migrating legacy settings format");const e=t.settings,s={};e.aiModel&&console.log("LearnSphere: Legacy aiModel setting found, migrating other settings"),e.theme&&(s.theme=e.theme),e.language&&(s.language=e.language),void 0!==e.autoSave&&(s.autoSaveHighlights=e.autoSave),void 0!==e.cloudSync&&(s.enableCloudSync=e.cloudSync),void 0!==e.notifications&&(s.enableNotifications=e.notifications),Object.keys(s).length>0&&(this.settings={...this.settings,...s},await this.saveSettings(),await chrome.storage.sync.remove(["settings"]),console.log("LearnSphere: Legacy settings migrated and cleaned up"))}}catch(t){console.warn("Failed to migrate legacy settings:",t)}}async saveSettings(){try{console.log("LearnSphere SettingsService: Saving settings to storage:",this.settings),await chrome.storage.sync.set({[this.storageKey]:this.settings}),console.log("LearnSphere SettingsService: Settings saved successfully"),this.applySettingsToPage()}catch(t){console.error("Failed to save settings to storage:",t)}}get(t){return this.settings[t]}async set(t,e){this.settings[t]=e,await this.saveSettings()}getAll(){return{...this.settings}}async update(t){this.settings={...this.settings,...t},await this.saveSettings()}async reset(){this.settings=this.getDefaultSettings(),await this.saveSettings()}hasGeminiApiKey(){return!!this.settings.geminiApiKey&&this.settings.geminiApiKey.trim().length>0}getGeminiApiKey(){return this.settings.geminiApiKey}async setGeminiApiKey(t){await this.set("geminiApiKey",t)}exportSettings(){return JSON.stringify(this.settings,null,2)}async importSettings(t){try{const e=JSON.parse(t);this.settings={...this.getDefaultSettings(),...e},await this.saveSettings()}catch(t){throw new Error("Invalid settings format")}}validateApiKey(t){return t.length>0&&t.includes("AIza")}async testApiKey(t){try{const e=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:"Hello"}]}],generationConfig:{temperature:.1,topK:1,topP:.1,maxOutputTokens:10}})});if(e.ok)return{valid:!0};{const t=await e.json();return{valid:!1,error:t.error?.message||`HTTP ${e.status}: ${e.statusText}`}}}catch(t){return{valid:!1,error:t instanceof Error?t.message:"Network error"}}}getThemeSettings(){const t="dark"===this.settings.theme;return{isDark:t,backgroundColor:t?"#1a1a1a":"#ffffff",textColor:t?"#ffffff":"#000000"}}getChatSidebarConfig(){return{position:this.settings.chatSidebarPosition,width:this.settings.chatSidebarWidth}}getAIConfig(){return{maxTokens:this.settings.maxTokens,temperature:this.settings.temperature}}getQuizConfig(){return{defaultDifficulty:this.settings.defaultQuizDifficulty,defaultQuestionCount:this.settings.defaultQuizQuestionCount,enableHints:this.settings.enableQuizHints,enableExplanations:this.settings.enableQuizExplanations,autoSaveResults:this.settings.autoSaveQuizResults}}getAccessibilityConfig(){return this.settings.accessibilityOptions}getPrivacyConfig(){return{enableLearningAnalytics:this.settings.enableLearningAnalytics,dataRetentionDays:this.settings.dataRetentionDays,enableCloudSync:this.settings.enableCloudSync,privacyMode:this.settings.privacyMode}}getHighlightConfig(){return{colors:this.settings.highlightColors,autoSave:this.settings.autoSaveHighlights}}getChatConfig(){return{position:this.settings.chatSidebarPosition,width:this.settings.chatSidebarWidth,autoOpen:this.settings.autoOpenChat}}getSystemTheme(){return"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}getEffectiveTheme(){return"auto"===this.settings.theme?this.getSystemTheme():this.settings.theme}async resetCategory(t){const e=this.getDefaultSettings();switch(t){case"ai":await this.update({maxTokens:e.maxTokens,temperature:e.temperature});break;case"quiz":await this.update({defaultQuizDifficulty:e.defaultQuizDifficulty,defaultQuizQuestionCount:e.defaultQuizQuestionCount,enableQuizHints:e.enableQuizHints,enableQuizExplanations:e.enableQuizExplanations,autoSaveQuizResults:e.autoSaveQuizResults});break;case"chat":await this.update({chatSidebarPosition:e.chatSidebarPosition,chatSidebarWidth:e.chatSidebarWidth,autoOpenChat:e.autoOpenChat});break;case"privacy":await this.update({enableLearningAnalytics:e.enableLearningAnalytics,dataRetentionDays:e.dataRetentionDays,enableCloudSync:e.enableCloudSync,privacyMode:e.privacyMode});break;case"accessibility":await this.update({accessibilityOptions:e.accessibilityOptions})}}async clearUserData(){try{await chrome.storage.local.clear(),await chrome.storage.sync.clear(),this.settings=this.getDefaultSettings(),await this.saveSettings()}catch(t){throw console.error("Failed to clear user data:",t),new Error("Failed to clear user data")}}async getDataUsage(){try{const e=await chrome.storage.local.get(null),s=await chrome.storage.sync.get(null),i=JSON.stringify(e).length,a=JSON.stringify(s).length;return{localStorageSize:i,syncStorageSize:a,estimatedSize:(t=i+a,t<1024?`${t} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1048576).toFixed(1)} MB`)}}catch(t){return console.error("Failed to get data usage:",t),{localStorageSize:0,syncStorageSize:0,estimatedSize:"0 B"}}var t}async exportAllUserData(){try{const[t,e]=await Promise.all([chrome.storage.local.get(null),chrome.storage.sync.get(null)]),s={version:"1.0.0",exportDate:(new Date).toISOString(),settings:this.settings,highlights:t.highlights||[],quizResults:t.quizResults||[],chatHistory:t.chatHistory||[],learningAnalytics:t.learning_analytics||{},documentData:Object.keys(t).filter(t=>t.startsWith("document_")).reduce((e,s)=>(e[s]=t[s],e),{})};return JSON.stringify(s,null,2)}catch(t){throw console.error("Failed to export user data:",t),new Error("Failed to export user data")}}async importAllUserData(t){try{const e=JSON.parse(t);if(!e.version||!e.settings)throw new Error("Invalid import data format");e.settings&&(this.settings={...this.getDefaultSettings(),...e.settings},await this.saveSettings());const s={};e.highlights&&(s.highlights=e.highlights),e.quizResults&&(s.quizResults=e.quizResults),e.chatHistory&&(s.chatHistory=e.chatHistory),e.learningAnalytics&&(s.learning_analytics=e.learningAnalytics),e.documentData&&Object.assign(s,e.documentData),Object.keys(s).length>0&&await chrome.storage.local.set(s),console.log("LearnSphere: User data imported successfully")}catch(t){throw console.error("Failed to import user data:",t),new Error("Failed to import user data: "+(t instanceof Error?t.message:"Unknown error"))}}validateSettings(){const t=[];return this.settings.geminiApiKey&&!this.validateApiKey(this.settings.geminiApiKey)&&t.push("Invalid Gemini API key format"),(this.settings.maxTokens<100||this.settings.maxTokens>8192)&&t.push("Max tokens must be between 100 and 8192"),(this.settings.temperature<0||this.settings.temperature>1)&&t.push("Temperature must be between 0 and 1"),(this.settings.chatSidebarWidth<300||this.settings.chatSidebarWidth>600)&&t.push("Chat sidebar width must be between 300 and 600 pixels"),(this.settings.defaultQuizQuestionCount<1||this.settings.defaultQuizQuestionCount>50)&&t.push("Default quiz question count must be between 1 and 50"),(this.settings.dataRetentionDays<0||this.settings.dataRetentionDays>3650)&&t.push("Data retention days must be between 0 and 3650 (10 years)"),Array.isArray(this.settings.highlightColors)&&0!==this.settings.highlightColors.length||t.push("At least one highlight color must be specified"),["en","es","fr","de","zh","ja"].includes(this.settings.language)||t.push("Invalid language code"),{valid:0===t.length,errors:t}}getSettingsSummary(){const t=[],e=[];return this.settings.geminiApiKey||t.push("Gemini API Key not configured"),this.settings.enableCloudSync&&!this.settings.geminiApiKey&&e.push("Cloud sync enabled but API key not configured"),this.settings.privacyMode&&this.settings.enableLearningAnalytics&&e.push("Privacy mode enabled but learning analytics still active"),{totalSettings:Object.keys(this.settings).length,configuredSettings:Object.values(this.settings).filter(t=>""!==t&&null!=t).length,criticalSettings:t,warnings:e}}}}}]);